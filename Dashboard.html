<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gestão de Obras Perfecta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .kpi-card, .obra-card {
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s, background-color 0.2s;
            cursor: pointer;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .progress-bar-bg { background-color: #e5e7eb; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        #item-status-chart, #material-status-chart { cursor: pointer; }
        .obra-card { border: 2px solid transparent; }
        .obra-selecionada {
            border-color: #2563eb;
            background-color: #bfdbfe;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
            </div>
        </header>

        <section id="filter-section" class="mb-6 bg-white p-4 rounded-xl border border-gray-200">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-x-8">
                    <h2 class="text-2xl font-bold text-red-600 flex-shrink-0">DASHBOARD DE OBRAS - PERFECTA</h2>
                    <div id="filtro-tipo-item-container" class="flex flex-wrap gap-x-6 gap-y-2"></div>
                </div>
                <div>
                    <button id="btn-limpar-filtros" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition flex-shrink-0">
                        <i class="fas fa-times mr-2"></i>Limpar Filtros
                    </button>
                </div>
            </div>
            <p id="active-filter-status" class="text-sm text-blue-600 font-medium mt-3 h-5"></p>
        </section>

        <section id="kpi-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div id="kpi-card-obras" class="kpi-card bg-white p-6 rounded-xl border border-gray-200 flex items-center gap-5"><div class="bg-blue-100 text-blue-600 rounded-full p-4 text-2xl"><i class="fas fa-ruler-combined"></i></div><div><p class="text-gray-500 text-sm font-medium">Medição - Atraso</p><p id="kpi-total-obras" class="text-3xl font-bold text-gray-800">...</p></div></div>
            <div id="kpi-card-pendentes" class="kpi-card bg-white p-6 rounded-xl border border-gray-200 flex items-center gap-5"><div class="bg-red-100 text-red-600 rounded-full p-4 text-2xl"><i class="fas fa-box-open"></i></div><div><p class="text-gray-500 text-sm font-medium">Materiais - Atraso</p><p id="kpi-materiais-pendentes" class="text-3xl font-bold text-gray-800">...</p></div></div>
            <div id="kpi-card-producao" class="kpi-card bg-white p-6 rounded-xl border border-gray-200 flex items-center gap-5"><div class="bg-green-100 text-green-600 rounded-full p-4 text-2xl"><i class="fas fa-th-large"></i></div><div><p class="text-gray-500 text-sm font-medium">Produção - Atraso</p><p id="kpi-progresso-geral" class="text-3xl font-bold text-gray-800">...</p></div></div>
            <div id="kpi-card-atrasadas" class="kpi-card bg-white p-6 rounded-xl border border-gray-200 flex items-center gap-5"><div class="bg-yellow-100 text-yellow-600 rounded-full p-4 text-2xl"><i class="fas fa-home"></i></div><div><p class="text-gray-500 text-sm font-medium">Entregas - Atraso</p><p id="kpi-obras-atrasadas" class="text-3xl font-bold text-gray-800">...</p></div></div>
        </section>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-gray-200"><div id="obras-list-container" class="space-y-4 max-h-[600px] overflow-y-auto custom-scrollbar pr-2"><p class="text-center text-gray-500 py-10">Carregando obras...</p></div></div>
            <div class="space-y-8">
                <div class="bg-white p-6 rounded-xl border border-gray-200">
                    <h3 class="text-lg font-bold text-red-600 mb-4">PRODUÇÃO</h3>
                    <div class="h-64 flex items-center justify-center"><canvas id="item-status-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-200">
                    <h3 class="text-lg font-bold text-red-600 mb-4">MATERIAIS</h3>
                    <div class="h-64 flex items-center justify-center"><canvas id="material-status-chart"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-3xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800"></h2>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-900 text-2xl font-bold">&times;</button>
            </div>
            <ul id="modal-list" class="overflow-y-auto custom-scrollbar space-y-2 pr-2">
            </ul>
        </div>
    </div>

    <div id="item-detail-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 id="item-detail-title" class="text-lg font-bold text-gray-800">Detalhes do Item</h2>
                <button id="item-detail-close-btn" class="text-gray-500 hover:text-gray-900 text-2xl font-bold">&times;</button>
            </div>
            <div class="overflow-y-auto custom-scrollbar pr-2 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div><span class="font-semibold text-gray-500">Etapa:</span><p id="item-detail-etapa" class="text-gray-800 font-medium"></p></div>
                    <div><span class="font-semibold text-gray-500">Status:</span><p id="item-detail-status" class="text-gray-800 font-medium"></p></div>
                    <div><span class="font-semibold text-gray-500">Data do Status:</span><p id="item-detail-data" class="text-gray-800 font-medium"></p></div>
                    <div><span class="font-semibold text-gray-500">Prazo Conclusão - Inicial:</span><p id="item-detail-prazo-inicial" class="text-gray-800 font-medium"></p></div>
                    <div><span class="font-semibold text-gray-500">Prazo Conclusão - Reagendado:</span><p id="item-detail-prazo-reagendado" class="text-gray-800 font-medium"></p></div>
                    <div><span class="font-semibold text-gray-500">Conclusão Efetiva:</span><p id="item-detail-conclusao-efetiva" class="text-gray-800 font-medium"></p></div>
                </div>
                <div>
                    <span class="font-semibold text-gray-500 text-sm">Observações:</span>
                    <div id="item-detail-observacoes" class="mt-1 w-full p-2 bg-gray-50 border rounded-md h-32 overflow-y-auto text-sm text-gray-800 custom-scrollbar whitespace-pre-wrap"></div>
                </div>
            </div>
        </div>
    </div>


<script type="module">
    // --- CONFIGURAÇÃO FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    const firebaseConfig = { apiKey: "AIzaSyDyNk5BJscelHhxjKRHKlOZpYnNKgnh3B4", authDomain: "controle-gc.firebaseapp.com", projectId: "controle-gc", storageBucket: "controle-gc.appspot.com", messagingSenderId: "197002816768", appId: "1:197002816768:web:a6a56f47421ea52961d7e5" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const obrasCollection = collection(db, 'obras');

    document.addEventListener('DOMContentLoaded', () => {
        let todasAsObras = [];
        let obrasVisiveisAtualmente = []; 
        let filtros = { tipoItem: [], statusItem: null, statusMaterial: null, kpi: null, obraId: null };
        let itemStatusChartInstance = null;
        let materialStatusChartInstance = null;

        let currentModalItems = [];
        let currentModalType = '';

        const TIPO_ITEM_MAP = { 'Compra Inicial': 'bg-orange-100 text-orange-800', 'Projeto': 'bg-blue-100 text-blue-800', 'Terceiros': 'bg-purple-100 text-purple-800' };
        const STATUS_ITEM_MAP = { 'nao-iniciado': 'Não iniciado', 'iniciado': 'Iniciado', 'parado': 'Parado', 'concluido': 'Concluído' };
        const STATUS_ITEM_COLORS = { 'concluido': '#166534', 'iniciado': '#f59e0b', 'nao-iniciado': '#9ca3af', 'parado': '#ef4444' };
        const STATUS_MATERIAL_MAP = { 'emCotacao': 'Em cotação', 'compraParcial': 'Compra Parcial', 'compraTotal': 'Compra Total', 'recebidoParcial': 'Recebido Parcial', 'recebidoTotal': 'Recebido Total', 'conferidoFalta': 'Conferido (Falta)', 'conferidoParcial': 'Conferido Parcial', 'conferidoTotal': 'Conferido Total', 'alocadoParcial': 'Alocado Parcial', 'alocadoTotal': 'Alocado Total' };
        const STATUS_MATERIAL_COLORS = { emCotacao: '#60a5fa', compraParcial: '#f59e0b', compraTotal: '#34d399', recebidoParcial: '#f59e0b', recebidoTotal: '#34d399', conferidoFalta: '#ef4444', conferidoParcial: '#f59e0b', conferidoTotal: '#34d399', alocadoParcial: '#f59e0b', alocadoTotal: '#166534' };
        
        const detailsModal = document.getElementById('details-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalList = document.getElementById('modal-list');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        
        const abrirModal = (titulo, conteudoHtml) => {
            modalTitle.textContent = titulo;
            modalList.innerHTML = conteudoHtml || `<li class="text-center text-gray-500 p-4">Nenhuma informação encontrada.</li>`;
            detailsModal.classList.remove('hidden');
        };
        const fecharModal = () => detailsModal.classList.add('hidden');
        modalCloseBtn.addEventListener('click', fecharModal);
        detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) fecharModal(); });
        
        const itemDetailModal = document.getElementById('item-detail-modal');
        const itemDetailCloseBtn = document.getElementById('item-detail-close-btn');

        const formatDate = (dateString) => dateString ? new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR') : 'dd/mm/aaaa';
        
        const abrirItemDetailModal = (item) => {
            const producaoInfo = item.etapas?.emProducao || {};
            document.getElementById('item-detail-title').textContent = `Item: ${item.codigo} - ${item.descricao}`;
            document.getElementById('item-detail-etapa').textContent = 'PRODUÇÃO';
            document.getElementById('item-detail-status').textContent = STATUS_ITEM_MAP[producaoInfo.status] || 'Não iniciado';
            document.getElementById('item-detail-data').textContent = formatDate(producaoInfo.data);
            document.getElementById('item-detail-prazo-inicial').textContent = formatDate(producaoInfo.prazoConclusaoInicial);
            document.getElementById('item-detail-prazo-reagendado').textContent = formatDate(producaoInfo.prazoConclusaoReagendado);
            document.getElementById('item-detail-conclusao-efetiva').textContent = formatDate(producaoInfo.conclusaoEfetiva);
            const obsText = Array.isArray(producaoInfo.observacao) ? producaoInfo.observacao.join('\n') : (producaoInfo.observacao || '');
            document.getElementById('item-detail-observacoes').textContent = obsText;
            itemDetailModal.classList.remove('hidden');
        };
        const fecharItemDetailModal = () => itemDetailModal.classList.add('hidden');
        itemDetailCloseBtn.addEventListener('click', fecharItemDetailModal);
        itemDetailModal.addEventListener('click', (e) => { if (e.target === itemDetailModal) fecharItemDetailModal(); });

        const showMaterialDetailsForItem = (item) => {
            const materials = (item.materiais || []).filter(mat => mat.statusInfo?.status !== 'cancelado');
            const modalContentHtml = generateMaterialListHtml(materials);
            abrirModal(`Materiais para: "${item.codigo || ''} - ${item.descricao || ''}"`, modalContentHtml);
        };

        modalList.addEventListener('click', (e) => {
            if (currentModalType !== 'item') return;
            
            const listItem = e.target.closest('li[data-index]');
            if (!listItem) return;

            const index = parseInt(listItem.dataset.index, 10);
            const selectedItem = currentModalItems[index];

            if (!selectedItem) return;

            if (e.target.closest('.material-badge-details')) {
                showMaterialDetailsForItem(selectedItem);
            } else {
                abrirItemDetailModal(selectedItem);
            }
        });

        const aplicarFiltrosERenderizar = () => {
            let obrasFiltradas = JSON.parse(JSON.stringify(todasAsObras)); 
            const today = new Date().setHours(0, 0, 0, 0);

            if (filtros.kpi === 'medicao-atraso') {
                obrasFiltradas = obrasFiltradas.filter(obra => {
                    if (obra.medicaoEfetuada) return false;
                    const dataMedicao = obra.novaPrevisaoMedicao || obra.previsaoInicialMedicao;
                    return dataMedicao && new Date(dataMedicao + 'T00:00:00') < today;
                });
            }
            if (filtros.kpi === 'atrasadas') {
                obrasFiltradas = obrasFiltradas.filter(obra => {
                    const dataEntrega = obra.novaPrevisaoEntrega || obra.previsaoInicialEntrega;
                    return dataEntrega && new Date(dataEntrega + 'T00:00:00') < today;
                });
            }

            if (filtros.obraId) {
                obrasFiltradas = obrasFiltradas.filter(obra => obra.id === filtros.obraId);
            }

            obrasFiltradas.forEach(obra => {
                if (!obra.itens) obra.itens = [];
                obra.itens = obra.itens.filter(item => {
                    const status = item.etapas?.emProducao?.status;
                    if (status === 'cancelado') return false; 

                    if (filtros.kpi === 'pecas-atraso') {
                        if (status === 'concluido') return false;
                        const dataPrazo = item.etapas?.emProducao?.prazoConclusaoReagendado || item.etapas?.emProducao?.prazoConclusaoInicial;
                        if (!dataPrazo || new Date(dataPrazo + 'T00:00:00') >= today) {
                            return false;
                        }
                    }
                    if (filtros.kpi === 'mat-atraso') {
                        const hasAtraso = (item.materiais || []).some(mat => {
                            const matStatus = mat.statusInfo?.status;
                            if (matStatus === 'alocadoTotal' || matStatus === 'cancelado') return false;
                            const dataPrevista = mat.statusInfo?.previsaoDisponibilidadeReagendado || mat.statusInfo?.previsaoDisponibilidadeInicial;
                            if (!dataPrevista) return false;
                            return new Date(dataPrevista + 'T00:00:00') < today;
                        });
                        if (!hasAtraso) return false;
                    }
                    
                    if (filtros.tipoItem.length > 0 && !filtros.tipoItem.includes(item.tipo)) return false;
                    if (filtros.statusItem && (status || 'nao-iniciado') !== filtros.statusItem) return false;
                    if (filtros.statusMaterial && !(item.materiais || []).some(mat => (mat.statusInfo?.status || 'emCotacao') === filtros.statusMaterial)) return false;
                    
                    return true;
                });
            });
            
            obrasVisiveisAtualmente = obrasFiltradas.filter(obra => obra.itens.length > 0);
            renderDashboard(obrasVisiveisAtualmente);
        };

        const limparFiltros = (clearTipoItem = true) => {
            const tipoItemAtual = filtros.tipoItem;
            filtros = { tipoItem: clearTipoItem ? [] : tipoItemAtual, statusItem: null, statusMaterial: null, kpi: null, obraId: null };
            document.getElementById('active-filter-status').textContent = '';
            if (clearTipoItem) document.querySelectorAll('.filtro-tipo-checkbox').forEach(cb => cb.checked = false);
            aplicarFiltrosERenderizar();
        };

        const adicionarListeners = () => {
            const tipoContainer = document.getElementById('filtro-tipo-item-container');
            tipoContainer.innerHTML = Object.keys(TIPO_ITEM_MAP).map(tipo => `<div class="flex items-center"><input type="checkbox" id="filtro-tipo-${tipo}" value="${tipo}" class="filtro-tipo-checkbox h-4 w-4 rounded"><label for="filtro-tipo-${tipo}" class="ml-2 text-sm text-gray-600">${tipo}</label></div>`).join('');
            
            tipoContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('filtro-tipo-checkbox')) {
                    filtros.tipoItem = [...tipoContainer.querySelectorAll('.filtro-tipo-checkbox:checked')].map(cb => cb.value);
                    aplicarFiltrosERenderizar();
                }
            });
            document.getElementById('obras-list-container').addEventListener('click', (e) => {
                const card = e.target.closest('.obra-card');
                if (card) {
                    const clickedObraId = card.dataset.obraId;
                    filtros.obraId = filtros.obraId === clickedObraId ? null : clickedObraId;
                    aplicarFiltrosERenderizar();
                }
            });

            document.getElementById('btn-limpar-filtros').addEventListener('click', () => limparFiltros(true));
            
            ['obras', 'pendentes', 'producao', 'atrasadas'].forEach(kpiType => {
                document.getElementById(`kpi-card-${kpiType}`).addEventListener('click', () => {
                    limparFiltros(false);
                    const statusEl = document.getElementById('active-filter-status');
                    let newKpi = null;
                    let newStatusText = '';

                    if (kpiType === 'obras') {
                        newKpi = 'medicao-atraso';
                        newStatusText = 'Filtro ativo: Obras com Medição Atrasada';
                    } else if (kpiType === 'producao') {
                        newKpi = 'pecas-atraso';
                        newStatusText = 'Filtro ativo: Obras com Produção em Atraso';
                    } else if (kpiType === 'atrasadas') {
                        newKpi = 'atrasadas';
                        newStatusText = 'Filtro ativo: Obras com Entregas em Atraso';
                    } else if (kpiType === 'pendentes') {
                        newKpi = 'mat-atraso';
                        newStatusText = 'Filtro ativo: Materiais com Entrega Atrasada';
                    }

                    filtros.kpi = filtros.kpi === newKpi ? null : newKpi;
                    statusEl.textContent = filtros.kpi ? newStatusText : '';
                    aplicarFiltrosERenderizar();
                });
            });
        };
        
        const renderDashboard = (obras) => {
            const obrasParaKPIs = JSON.parse(JSON.stringify(todasAsObras));
            if (filtros.tipoItem.length > 0) {
                 obrasParaKPIs.forEach(obra => {
                    if (obra.itens) {
                        obra.itens = obra.itens.filter(item => filtros.tipoItem.includes(item.tipo));
                    }
                });
            }
            
            calculateAndRenderKPIs(obrasParaKPIs);
            renderObrasList(filtros.kpi === 'medicao-atraso' || filtros.kpi === 'atrasadas' ? obras : todasAsObras, obras);
            renderCharts(obras);
        };
        
        const calculateAndRenderKPIs = (obras) => {
            let medicaoComAtraso = 0, pecasComAtraso = 0, obrasAtrasadas = 0, materiaisComAtraso = 0;
            const today = new Date().setHours(0,0,0,0);

            obras.forEach(obra => {
                if (filtros.tipoItem.length > 0 && (!obra.itens || obra.itens.length === 0)) {
                    return; 
                }

                if (!obra.medicaoEfetuada) {
                    const dataMedicao = obra.novaPrevisaoMedicao || obra.previsaoInicialMedicao;
                    if (dataMedicao && new Date(dataMedicao + 'T00:00:00') < today) {
                        medicaoComAtraso++;
                    }
                }

                const dataEntrega = obra.novaPrevisaoEntrega || obra.previsaoInicialEntrega;
                if (dataEntrega && new Date(dataEntrega + 'T00:00:00') < today) {
                    obrasAtrasadas++;
                }

                (obra.itens || []).forEach(item => {
                    const status = item.etapas?.emProducao?.status;
                    if (status === 'cancelado') return;

                    if (status !== 'concluido') {
                        const dataPrazo = item.etapas?.emProducao?.prazoConclusaoReagendado || item.etapas?.emProducao?.prazoConclusaoInicial;
                        if (dataPrazo && new Date(dataPrazo + 'T00:00:00') < today) {
                            pecasComAtraso++;
                        }
                    }
                    
                    (item.materiais || []).forEach(mat => {
                        const matStatus = mat.statusInfo?.status;
                        if (matStatus !== 'alocadoTotal' && matStatus !== 'cancelado') {
                            const dataPrevista = mat.statusInfo?.previsaoDisponibilidadeReagendado || mat.statusInfo?.previsaoDisponibilidadeInicial;
                            if (dataPrevista && new Date(dataPrevista + 'T00:00:00') < today) {
                                materiaisComAtraso++;
                            }
                        }
                    });
                });
            });
            
            document.getElementById('kpi-total-obras').textContent = medicaoComAtraso;
            document.getElementById('kpi-progresso-geral').textContent = pecasComAtraso;
            document.getElementById('kpi-obras-atrasadas').textContent = obrasAtrasadas;
            document.getElementById('kpi-materiais-pendentes').textContent = materiaisComAtraso;
        };

        const renderObrasList = (obrasParaMostrar, obrasFiltradas) => {
            const container = document.getElementById('obras-list-container');
            if (obrasParaMostrar.length === 0) { container.innerHTML = `<p class="text-center text-gray-500 py-10">Nenhuma obra encontrada.</p>`; return; }
            
            container.innerHTML = obrasParaMostrar.map(obra => {
                const obraAnalisada = obrasFiltradas.find(o => o.id === obra.id) || { itens: [] };
                
                const itensAtivosDaObra = obraAnalisada.itens.filter(i => i.etapas?.emProducao?.status !== 'cancelado');
                const itensProducao = itensAtivosDaObra.filter(i => ['Projeto', 'Terceiros'].includes(i.tipo));
                
                const producaoConcluida = itensProducao.filter(item => item.etapas?.emProducao?.status === 'concluido').length;
                const percentualProducao = itensProducao.length > 0 ? Math.round((producaoConcluida / itensProducao.length) * 100) : 0;
                
                let totalMateriais = 0, materiaisAlocados = 0;
                itensAtivosDaObra.forEach(item => {
                    const materiaisAtivos = (item.materiais || []).filter(mat => mat.statusInfo?.status !== 'cancelado');
                    totalMateriais += materiaisAtivos.length;
                    materiaisAlocados += materiaisAtivos.filter(mat => mat.statusInfo?.status === 'alocadoTotal').length;
                });
                const percentualMateriais = totalMateriais > 0 ? Math.round((materiaisAlocados / totalMateriais) * 100) : 0;
                
                let medicaoTextoFinal;
                if (obra.medicaoEfetuada) {
                    medicaoTextoFinal = `Medição (Realizada): ${new Date(obra.medicaoEfetuada + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                } else if (obra.novaPrevisaoMedicao) {
                    medicaoTextoFinal = `Medição (Nova Prev.): ${new Date(obra.novaPrevisaoMedicao + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                } else if (obra.previsaoInicialMedicao) {
                    medicaoTextoFinal = `Medição (Previsão): ${new Date(obra.previsaoInicialMedicao + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                } else {
                    medicaoTextoFinal = 'Medição: A definir';
                }

                let entregaTextoFinal = `Entrega (Previsão): A definir`;
                if (obra.novaPrevisaoEntrega) {
                    entregaTextoFinal = `Entrega (Nova Prev.): ${new Date(obra.novaPrevisaoEntrega + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                } else if (obra.previsaoInicialEntrega) {
                    entregaTextoFinal = `Entrega (Previsão): ${new Date(obra.previsaoInicialEntrega + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                }

                const isSelectedClass = obra.id === filtros.obraId ? 'obra-selecionada' : '';
                return `<div class="obra-card border-2 rounded-lg p-4 ${isSelectedClass}" data-obra-id="${obra.id}"><div class="flex flex-col sm:flex-row justify-between items-start"><div><h4 class="font-bold text-lg text-gray-800">${obra.nome}</h4><p class="text-sm text-gray-500">${obra.cliente}</p></div><div class="text-sm mt-2 sm:mt-0 sm:text-right"><p class="font-semibold text-gray-700">${medicaoTextoFinal}</p><p class="font-semibold text-gray-700">${entregaTextoFinal}</p></div></div><div class="mt-4 space-y-3"><div><div class="flex justify-between items-center mb-1"><span class="text-xs font-medium text-gray-600">Progresso (Materiais)</span><span class="text-xs font-bold text-green-600">${percentualMateriais}% (${materiaisAlocados}/${totalMateriais})</span></div><div class="w-full progress-bar-bg rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width: ${percentualMateriais}%"></div></div></div><div><div class="flex justify-between items-center mb-1"><span class="text-xs font-medium text-gray-600">Progresso (Produção)</span><span class="text-xs font-bold text-blue-600">${percentualProducao}% (${producaoConcluida}/${itensProducao.length})</span></div><div class="w-full progress-bar-bg rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentualProducao}%"></div></div></div></div></div>`;
            }).join('');
        };
        
        const renderCharts = (obras) => {
            const itemStatusCounts = {}, materialStatusCounts = {};
            obras.forEach(obra => {
                (obra.itens || []).forEach(item => {
                    const itemStatus = item.etapas?.emProducao?.status || 'nao-iniciado';
                    if (itemStatus === 'cancelado') return; 
                    
                    if (item.tipo === 'Projeto') {
                        if (STATUS_ITEM_MAP[itemStatus]) itemStatusCounts[itemStatus] = (itemStatusCounts[itemStatus] || 0) + 1;
                    }
                    
                    (item.materiais || []).forEach(mat => {
                        const matStatus = mat.statusInfo?.status || 'emCotacao';
                        if (matStatus !== 'cancelado' && STATUS_MATERIAL_MAP[matStatus]) {
                             materialStatusCounts[matStatus] = (materialStatusCounts[matStatus] || 0) + 1;
                        }
                    });
                });
            });

            if(itemStatusChartInstance) itemStatusChartInstance.destroy();
            const itemStatusLabels = Object.keys(itemStatusCounts);
            const itemBackgroundColors = itemStatusLabels.map(statusKey => STATUS_ITEM_COLORS[statusKey] || '#d1d5db');
            itemStatusChartInstance = new Chart(document.getElementById('item-status-chart').getContext('2d'), { type: 'doughnut', data: { labels: itemStatusLabels.map(k => STATUS_ITEM_MAP[k]), datasets: [{ data: Object.values(itemStatusCounts), backgroundColor: itemBackgroundColors, borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } }, onClick: (e, el) => handleChartClick(e, el, itemStatusChartInstance, 'item') } });
            
            if(materialStatusChartInstance) materialStatusChartInstance.destroy();
            const materialLabels = Object.keys(materialStatusCounts);
            const backgroundColors = materialLabels.map(statusKey => STATUS_MATERIAL_COLORS[statusKey] || '#d1d5db');
            materialStatusChartInstance = new Chart(document.getElementById('material-status-chart').getContext('2d'), { type: 'bar', data: { labels: materialLabels.map(k => STATUS_MATERIAL_MAP[k]), datasets: [{ label: 'Quantidade', data: Object.values(materialStatusCounts), backgroundColor: backgroundColors }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { font: { size: 10 } } } }, onClick: (e, el) => handleChartClick(e, el, materialStatusChartInstance, 'material') } });
        };
        
        const generateMaterialListHtml = (materials) => {
            if (!materials || materials.length === 0) return '';
            return materials.map(mat => {
                const currentStatusKey = mat.statusInfo?.status || 'emCotacao';
                const currentStatusText = STATUS_MATERIAL_MAP[currentStatusKey];
                const statusBadge = `<span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${currentStatusText}</span>`;
                
                let dataDisponibilidadeHtml = '';
                let dataInfo = null;
                if (mat.statusInfo?.disponibilidadeTotal) {
                    dataInfo = { label: 'Disponível em:', date: mat.statusInfo.disponibilidadeTotal };
                } else if (mat.statusInfo?.previsaoDisponibilidadeReagendado) {
                    dataInfo = { label: 'Prev. Reagendada:', date: mat.statusInfo.previsaoDisponibilidadeReagendado };
                } else if (mat.statusInfo?.previsaoDisponibilidadeInicial) {
                    dataInfo = { label: 'Prev. Inicial:', date: mat.statusInfo.previsaoDisponibilidadeInicial };
                }

                if (dataInfo) {
                    const formattedDate = new Date(dataInfo.date + 'T00:00:00').toLocaleDateString('pt-BR');
                    dataDisponibilidadeHtml = `<span>${dataInfo.label} <span class="font-medium text-blue-600">${formattedDate}</span></span>`;
                } else {
                    dataDisponibilidadeHtml = `<span></span>`;
                }

                return `<li class="p-3 rounded-md hover:bg-gray-100 border-b last:border-b-0">
                            <div class="flex justify-between items-start">
                                <p class="font-semibold text-gray-800 flex-1">${mat.tipo} - ${mat.descricao}</p>${statusBadge}
                            </div>
                            <div class="mt-2 text-sm grid grid-cols-1 sm:grid-cols-3 gap-x-4 text-gray-600">
                                <span><strong>Qtd. Orçada:</strong> ${mat.qtdeOrcada || '-'}</span>
                                <span><strong>Qtd. Disponível:</strong> ${mat.qtdeDisponivel || '-'}</span>
                                ${dataDisponibilidadeHtml}
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Item: ${mat.itemCodigo} | Obra: ${mat.obraNome}</p>
                        </li>`;
            }).join('');
        };
        
        const handleChartClick = (event, elements, chartInstance, chartType) => {
            if (elements.length === 0) return;
            const label = chartInstance.data.labels[elements[0].index];
            const map = chartType === 'item' ? STATUS_ITEM_MAP : STATUS_MATERIAL_MAP;
            const statusKey = Object.keys(map).find(k => map[k] === label);
            let modalContentHtml = '';

            if (chartType === 'item') {
                const matchingItems = [];
                obrasVisiveisAtualmente.forEach(obra => {
                    (obra.itens || []).forEach(item => {
                        const itemStatus = item.etapas?.emProducao?.status || 'nao-iniciado';
                        if (itemStatus === 'cancelado') return;

                        if (item.tipo === 'Projeto' && itemStatus === statusKey) {
                            matchingItems.push({ ...item, obraNome: obra.nome, obraId: obra.id });
                        }
                    });
                });

                currentModalItems = matchingItems; 
                currentModalType = 'item';

                modalContentHtml = matchingItems.length > 0 ? matchingItems.map((item, index) => {
                    let badgeHtml = '';
                    const materiaisAtivos = (item.materiais || []).filter(mat => mat.statusInfo?.status !== 'cancelado');
                    if (materiaisAtivos.length > 0) {
                        const materiaisConcluidos = materiaisAtivos.filter(mat => mat.statusInfo?.status === 'alocadoTotal').length;
                        const percentual = Math.round((materiaisConcluidos / materiaisAtivos.length) * 100);
                        let badgeClasses = 'bg-yellow-100 text-yellow-800';
                        if (percentual === 100) badgeClasses = 'bg-green-100 text-green-800';
                        else if (percentual === 0) badgeClasses = 'bg-red-100 text-red-800';
                        badgeHtml = `<span class="${badgeClasses} text-xs font-semibold ml-3 px-2.5 py-0.5 rounded-full material-badge-details">${percentual}% Mat.</span>`;
                    }

                    let dataProducaoTexto = '';
                    const producao = item.etapas?.emProducao;
                    if (producao) {
                        if (producao.conclusaoEfetiva) {
                            dataProducaoTexto = `Concluído: ${new Date(producao.conclusaoEfetiva + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                        } else if (producao.prazoConclusaoReagendado) {
                            dataProducaoTexto = `Reagendado: ${new Date(producao.prazoConclusaoReagendado + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                        } else if (producao.prazoConclusaoInicial) {
                            dataProducaoTexto = `Prazo: ${new Date(producao.prazoConclusaoInicial + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                        }
                    }

                    return `<li data-index="${index}" class="cursor-pointer p-3 rounded-md hover:bg-gray-100 transition-colors">
                                <div class="flex justify-between items-center">
                                    <p class="font-semibold text-gray-800">${item.codigo || ''} - ${item.descricao || ''}</p>${badgeHtml}
                                </div>
                                <div class="flex justify-between items-center mt-1 text-sm">
                                    <p class="text-gray-500">Obra: ${item.obraNome}</p>${dataProducaoTexto ? `<p class="font-medium text-blue-600">${dataProducaoTexto}</p>` : ''}
                                </div>
                            </li>`;
                }).join('') : '';
            } else { 
                currentModalType = 'material';
                const matchingMaterials = [];
                obrasVisiveisAtualmente.forEach(obra => {
                    (obra.itens || []).forEach(item => {
                         if (item.etapas?.emProducao?.status === 'cancelado') return;

                        (item.materiais || []).forEach(material => {
                            const matStatus = material.statusInfo?.status || 'emCotacao';
                            if (matStatus === statusKey && matStatus !== 'cancelado') {
                                matchingMaterials.push({ ...material, obraNome: obra.nome, itemCodigo: item.codigo });
                            }
                        });
                    });
                });
                modalContentHtml = generateMaterialListHtml(matchingMaterials);
            }
            abrirModal(`Detalhes para: "${label}"`, modalContentHtml);
        };

        adicionarListeners();
        onAuthStateChanged(auth, user => {
            if (user) {
                onSnapshot(obrasCollection, (querySnapshot) => {
                    const allFetchedObras = [];
                    querySnapshot.forEach((doc) => allFetchedObras.push({ id: doc.id, ...doc.data() }));
                    
                    todasAsObras = allFetchedObras.filter(obra => !obra.entregaRealizada);
                    todasAsObras.forEach(obra => {
                        if (obra.itens) {
                            obra.itens = obra.itens.filter(item => item.tipo !== 'Orçamento');
                        }
                    });

                    aplicarFiltrosERenderizar();
                }, (error) => { console.error("Erro:", error); });
            } else {
                signInAnonymously(auth).catch(error => console.error("Erro:", error));
            }
        });
    });
</script>

</body>
</html>