<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTÃO DE OBRAS - Perfecta (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .status-badge {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            position: relative;
        }
        .status-badge:hover {
            /* Efeito de hover sutil para design flat */
            filter: brightness(110%);
        }
        .action-btn {
            padding: 0.3rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s, border-color 0.2s;
        }
        .action-btn:hover {
            /* O feedback de hover será tratado por classes do Tailwind diretamente no HTML */
        }

        /* --- STATUS DOS ITENS (Cores Vibrantes) --- */
        .status-item-nao-iniciado { background-color: #ffffff; color: #1f2937; border: 1px solid #d1d5db; }
        .status-item-iniciado { background-color: #0ea5e9; color: white; } /* sky-500 */
        .status-item-parado { background-color: #1f2937; color: white; } /* gray-800 */
        .status-item-concluido { background-color: #16a34a; color: white; } /* green-600 */
        .status-item-cancelado { background-color: #6b7280; color: white; } /* gray-500 */

        /* --- STATUS DOS MATERIAIS (Cores Vibrantes) --- */
        .status-mat-conferenciaEstoque { background-color: #14b8a6; color: white; } /* teal-500 */
        .status-mat-emCotacao { background-color: #ffffff; color: #1f2937; border: 1px solid #d1d5db; }
        .status-mat-compraParcial { background-color: #f97316; color: white; } /* orange-500 */
        .status-mat-compraTotal { background-color: #16a34a; color: white; } /* green-600 */
        .status-mat-recebidoParcial { background-color: #f97316; color: white; } /* orange-500 */
        .status-mat-recebidoTotal { background-color: #16a34a; color: white; } /* green-600 */
        .status-mat-conferidoFalta { background-color: #ef4444; color: white; } /* red-500 */
        .status-mat-conferidoParcial { background-color: #f97316; color: white; } /* orange-500 */
        .status-mat-conferidoTotal { background-color: #16a34a; color: white; } /* green-600 */
        .status-mat-alocadoParcial { background-color: #f97316; color: white; } /* orange-500 */
        .status-mat-alocadoTotal { background-color: #16a34a; color: white; } /* green-600 */
        .status-mat-cancelado { background-color: #1f2937; color: white; } /* gray-800 */


        .modal { transition: opacity 0.2s ease-in-out; }
        .modal-content { transition: opacity 0.2s ease-in-out; }
        .table-container { overflow-x: auto; }
        .materiais-row td { padding: 0 !important; border: 0; }
        .material-status-badge { padding: 0.25rem 0.5rem; font-size: 0.8rem; }

        .material-cell {
            font-size: 0.7rem; /* 30% menor que o padrão (aprox. 1rem) */
            vertical-align: middle;
        }

        /* --- CLASSES PARA A BARRA DE PROGRESSO --- */
        .progress-bar-container {
            position: relative;
            overflow: hidden; /* Garante que o preenchimento fique dentro das bordas arredondadas */
        }
        .progress-bar-text {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5); /* Melhora a legibilidade sobre cores claras */
        }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">GESTÃO DE OBRAS - Perfecta (Firebase)</h1>
            </div>
            <div class="flex items-center gap-4">
                <a href="Dashboard.html" target="_blank" class="bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-700 transition flex-shrink-0">DASHBOARD</a>
                <button id="btn-toggle-form-obra" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-800 transition flex-shrink-0">NOVA OBRA</button>
            </div>
        </header>

        <div id="form-nova-obra-container" class="hidden">
            <div class="bg-white p-6 rounded-xl mb-6 border border-gray-200">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Adicionar Nova Obra</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="inputNomeObra" placeholder="Nome da Obra ou Projeto*" class="p-3 border rounded-lg focus:border-blue-500 focus:ring-0">
                    <input type="text" id="inputClienteObra" placeholder="Nome do Cliente*" class="p-3 border rounded-lg focus:border-blue-500 focus:ring-0">
                    <input type="text" id="inputEnderecoObra" placeholder="Endereço" class="md:col-span-2 p-3 border rounded-lg focus:border-blue-500 focus:ring-0">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 border-t border-b py-4 mb-4">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">MEDIÇÃO</h4>
                        <label for="inputPrevisaoInicialMedicao" class="text-sm font-medium text-gray-600">Previsão Inicial</label>
                        <input type="date" id="inputPrevisaoInicialMedicao" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="inputNovaPrevisaoMedicao" class="text-sm font-medium text-gray-600 mt-2 block">Nova Previsão</label>
                        <input type="date" id="inputNovaPrevisaoMedicao" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="inputMedicaoEfetuada" class="text-sm font-medium text-gray-600 mt-2 block">Realizada</label>
                        <input type="date" id="inputMedicaoEfetuada" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="inputObsMedicao" class="text-sm font-medium text-gray-600 mt-2 block">Observações</label>
                        <textarea id="inputObsMedicao" rows="2" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0"></textarea>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">FINALIZAÇÃO</h4>
                        <label for="inputPrevisaoInicialEntrega" class="text-sm font-medium text-gray-600">Previsão Inicial</label>
                        <input type="date" id="inputPrevisaoInicialEntrega" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="inputNovaPrevisaoEntrega" class="text-sm font-medium text-gray-600 mt-2 block">Nova Previsão</label>
                        <input type="date" id="inputNovaPrevisaoEntrega" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="inputEntregaRealizada" class="text-sm font-medium text-gray-600 mt-2 block">Realizada</label>
                        <input type="date" id="inputEntregaRealizada" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="inputObsEntrega" class="text-sm font-medium text-gray-600 mt-2 block">Observações</label>
                        <textarea id="inputObsEntrega" rows="2" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0"></textarea>
                    </div>
                </div>
                <button id="btnAdicionarObra" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-800 transition w-full">Adicionar Obra</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl mb-8 border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">Filtros de Consulta</h3>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-x-6 gap-y-4">
                <div class="md:col-span-2">
                    <label for="filtro-nome-obra" class="text-sm font-medium text-gray-600">Nome da Obra</label>
                    <input type="text" id="filtro-nome-obra" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                </div>
                <div class="md:col-span-4">
                    <label class="text-sm font-medium text-gray-600">Tipo de Item</label>
                    <div id="filtro-tipo-item-container" class="flex flex-wrap gap-x-4 gap-y-2 mt-2">
                    </div>
                </div>
                <div id="filtros-status-item-container" class="md:col-span-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-x-6 gap-y-4 pt-4 border-t"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4 border-t pt-4">
                <div class="md:col-span-4">
                    <label class="text-sm font-medium text-gray-600">Status do Material</label>
                    <div id="filtro-status-material-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-x-4 gap-y-2 mt-2">
                    </div>
                </div>
            </div>
        </div>

        <div id="obras-container" class="space-y-4">
            <div class="text-center p-8 bg-white rounded-lg border border-gray-200"><h3 class="text-lg font-medium text-gray-700">Carregando dados do Firebase...</h3><p class="text-gray-500 mt-1">Por favor, aguarde.</p></div>
        </div>
    </div>

    <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-lg mx-auto modal-content flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800 mb-2" id="modal-header">Atualizar Status</h2>
                <p class="text-gray-600 mb-6" id="modal-title">Item: <span class="font-semibold" id="modal-item-nome"></span><span id="modal-etapa-container"> | Etapa: <span class="font-semibold" id="modal-etapa-nome"></span></span></p>
            </div>
            
            <div class="overflow-y-auto pr-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <div id="modal-status-container" class="space-y-2">
                            </div>
                    </div>

                    <div id="modal-prazo-container" class="hidden">
                        <label for="modal-prazo-inicial" class="block text-sm font-medium text-gray-700 mb-1">Prazo Conclusão - Inicial</label>
                        <input type="date" id="modal-prazo-inicial" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0">
                        <label for="modal-prazo-reagendado" class="block text-sm font-medium text-gray-700 mb-1 mt-2">Prazo Conclusão - Reagendado</label>
                        <input type="date" id="modal-prazo-reagendado" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0">
                    </div>

                    <div id="modal-conclusao-final-container" class="hidden">
                        <label for="modal-conclusao-final" class="block text-sm font-medium text-gray-700 mb-1 mt-2">Conclusão Final</label>
                        <input type="date" id="modal-conclusao-final" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-0" readonly>
                    </div>

                    <div id="modal-conclusao-efetiva-container" class="hidden">
                        <label for="modal-conclusao-efetiva" class="block text-sm font-medium text-gray-700 mb-1 mt-2">Conclusão Efetiva</label>
                        <input type="date" id="modal-conclusao-efetiva" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-0" readonly>
                    </div>

                    <div id="modal-entrega-final-container" class="hidden">
                        <label for="modal-entrega-final" class="block text-sm font-medium text-gray-700 mb-1 mt-2">Transporte Final</label>
                        <input type="date" id="modal-entrega-final" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-0" readonly>
                    </div>

                    <div id="modal-instalacao-final-container" class="hidden">
                        <label for="modal-instalacao-final" class="block text-sm font-medium text-gray-700 mb-1 mt-2">Instalação Final</label>
                        <input type="date" id="modal-instalacao-final" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-0" readonly>
                    </div>

                    <div id="modal-previsao-container" class="hidden">
                        <label for="modal-previsao-disponibilidade-inicial" class="block text-sm font-medium text-gray-700 mb-1">Previsão Disponibilidade - Inicial</label>
                        <input type="date" id="modal-previsao-disponibilidade-inicial" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0">
                        <label for="modal-previsao-disponibilidade-reagendado" class="block text-sm font-medium text-gray-700 mb-1 mt-2">Previsão Disponibilidade - Reagendado</label>
                        <input type="date" id="modal-previsao-disponibilidade-reagendado" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0">
                        <label for="modal-disponibilidade-total" class="block text-sm font-medium text-gray-700 mb-1 mt-2">Disponibilidade Total</label>
                        <input type="date" id="modal-disponibilidade-total" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-0" readonly>
                    </div>

                    <div><label for="modal-obs" class="block text-sm font-medium text-gray-700 mb-1">Observação</label><textarea id="modal-obs" rows="4" placeholder="Adicione uma observação..." class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></textarea></div>
                </div>
            </div>
            
            <div class="flex justify-end items-center mt-auto pt-6 border-t flex-shrink-0">
                <div class="flex gap-4">
                    <button id="modal-btn-cancelar" class="bg-transparent text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-100 border border-gray-300 transition">Cancelar</button>
                    <button id="modal-btn-salvar" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-item-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-lg mx-auto modal-content overflow-y-auto max-h-screen">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Alterar Item</h2>
            <div class="space-y-4">
                <div>
                    <label for="edit-item-tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                    <select id="edit-item-tipo" class="w-full p-3 border rounded-lg bg-gray-100 cursor-not-allowed focus:border-blue-500 focus:ring-0">
                        <option value="Projeto">Projeto</option>
                        <option value="Orçamento">Orçamento</option>
                        <option value="Revisão">Revisão</option>
                        <option value="Terceiros">Terceiros</option>
                        <option value="Compra Inicial">Compra Inicial</option>
                    </select>
                </div>
                <div><label for="edit-item-codigo" class="block text-sm font-medium text-gray-700 mb-1">Código</label><input type="text" id="edit-item-codigo" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                <div><label for="edit-item-descricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><input type="text" id="edit-item-descricao" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>

                <div id="edit-item-projeto-fields" class="hidden space-y-4 border-t pt-4">
                     <div><label for="edit-item-largura" class="block text-sm font-medium text-gray-700 mb-1">Largura</label><input type="text" id="edit-item-largura" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                     <div><label for="edit-item-altura" class="block text-sm font-medium text-gray-700 mb-1">Altura</label><input type="text" id="edit-item-altura" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                     <div><label for="edit-item-m2-total" class="block text-sm font-medium text-gray-700 mb-1">M² Total</label><input type="text" id="edit-item-m2-total" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                     <div><label for="edit-item-cor" class="block text-sm font-medium text-gray-700 mb-1">Cor</label><input type="text" id="edit-item-cor" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                     <div><label for="edit-item-vidro" class="block text-sm font-medium text-gray-700 mb-1">Vidro</label><input type="text" id="edit-item-vidro" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                     <div><label for="edit-item-m2-vidro" class="block text-sm font-medium text-gray-700 mb-1">M² Vidro</label><input type="text" id="edit-item-m2-vidro" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                </div>

                <div id="edit-item-orcamento-revisao-fields" class="hidden space-y-4 border-t pt-4">
                    <div id="edit-orcamento-fields-container" class="hidden">
                        <label for="edit-item-qtd-pecas" class="block text-sm font-medium text-gray-700 mb-1">Qtd Peças</label>
                        <input type="number" id="edit-item-qtd-pecas" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0">
                    </div>
                    <div id="edit-revisao-fields-container" class="hidden space-y-4">
                        <div>
                            <label for="edit-item-versao" class="block text-sm font-medium text-gray-700 mb-1">Versão</label>
                            <input type="text" id="edit-item-versao" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="edit-item-revisao-check" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="edit-item-revisao-check" class="ml-2 block text-sm text-gray-900">Solicitada Alteração</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="edit-item-btn-cancelar" class="bg-transparent text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-100 border border-gray-300 transition">Cancelar</button>
                <button id="edit-item-btn-salvar" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-800 transition">Salvar</button>
            </div>
        </div>
    </div>

    <div id="edit-material-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-lg mx-auto modal-content overflow-y-auto max-h-screen">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Alterar Material</h2>
            <div class="space-y-4">
                <div><label for="edit-material-tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label><input type="text" id="edit-material-tipo" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                <div><label for="edit-material-descricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><input type="text" id="edit-material-descricao" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>

                <div id="edit-material-compra-fields" class="hidden space-y-4 border-t pt-4">
                    <div><label for="edit-material-qtde-orcada" class="block text-sm font-medium text-gray-700 mb-1">Qtde Orçada</label><input type="number" id="edit-material-qtde-orcada" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                    <div><label for="edit-material-qtde-disponivel" class="block text-sm font-medium text-gray-700 mb-1">Qtde Disponível</label><input type="number" id="edit-material-qtde-disponivel" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="edit-material-btn-cancelar" class="bg-transparent text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-100 border border-gray-300 transition">Cancelar</button>
                <button id="edit-material-btn-salvar" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-800 transition">Salvar</button>
            </div>
        </div>
    </div>

    <div id="edit-obra-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-3xl mx-auto modal-content flex flex-col max-h-[90vh]">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex-shrink-0">Alterar Obra</h2>

            <div class="overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label for="edit-obra-nome" class="block text-sm font-medium text-gray-700 mb-1">Nome da Obra</label><input type="text" id="edit-obra-nome" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                    <div><label for="edit-obra-cliente" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente</label><input type="text" id="edit-obra-cliente" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                    <div class="md:col-span-2"><label for="edit-obra-endereco" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label><input type="text" id="edit-obra-endereco" class="w-full p-3 border rounded-lg focus:border-blue-500 focus:ring-0"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 border-t pt-4">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">MEDIÇÃO</h4>
                        <label for="edit-obra-previsao-inicial-medicao" class="text-sm font-medium text-gray-600">Previsão Inicial</label>
                        <input type="date" id="edit-obra-previsao-inicial-medicao" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="edit-obra-nova-previsao-medicao" class="text-sm font-medium text-gray-600 mt-2 block">Nova Previsão</label>
                        <input type="date" id="edit-obra-nova-previsao-medicao" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="edit-obra-medicao-efetuada" class="text-sm font-medium text-gray-600 mt-2 block">Realizada</label>
                        <input type="date" id="edit-obra-medicao-efetuada" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="edit-obra-obs-medicao" class="text-sm font-medium text-gray-600 mt-2 block">Observações</label>
                        <textarea id="edit-obra-obs-medicao" rows="2" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0"></textarea>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">FINALIZAÇÃO</h4>
                        <label for="edit-obra-previsao-inicial-entrega" class="text-sm font-medium text-gray-600">Previsão Inicial</label>
                        <input type="date" id="edit-obra-previsao-inicial-entrega" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="edit-obra-nova-previsao-entrega" class="text-sm font-medium text-gray-600 mt-2 block">Nova Previsão</label>
                        <input type="date" id="edit-obra-nova-previsao-entrega" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="edit-obra-entrega-realizada" class="text-sm font-medium text-gray-600 mt-2 block">Realizada</label>
                        <input type="date" id="edit-obra-entrega-realizada" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0">
                        <label for="edit-obra-obs-entrega" class="text-sm font-medium text-gray-600 mt-2 block">Observações</label>
                        <textarea id="edit-obra-obs-entrega" rows="2" class="w-full p-2 border rounded-lg mt-1 focus:border-blue-500 focus:ring-0"></textarea>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-auto border-t pt-6 flex-shrink-0">
                <button id="edit-obra-btn-cancelar" class="bg-transparent text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-100 border border-gray-300 transition">Cancelar</button>
                <button id="edit-obra-btn-salvar" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-800 transition">Salvar</button>
            </div>
        </div>
    </div>


<script type="module">
    // --- INÍCIO: CONFIGURAÇÃO FIREBASE ---
    // Importar funções necessárias dos SDKs do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Configuração do seu projeto Firebase.
    const firebaseConfig = {
        apiKey: "AIzaSyDyNk5BJscelHhxjKRHKlOZpYnNKgnh3B4",
        authDomain: "controle-gc.firebaseapp.com",
        projectId: "controle-gc",
        storageBucket: "controle-gc.appspot.com",
        messagingSenderId: "197002816768",
        appId: "1:197002816768:web:a6a56f47421ea52961d7e5"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Referência para a coleção 'obras' no Firestore
    const obrasCollection = collection(db, 'obras');
    // --- FIM: CONFIGURAÇÃO FIREBASE ---

document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURAÇÕES GLOBAIS ---
    const ETAPAS_ITEM = [ { id: 'alteracaoProjeto', nome: 'ORÇAMENTO' }, { id: 'projetoFinal', nome: 'LISTA' }, { id: 'emProducao', nome: 'PRODUÇÃO' }, { id: 'entregue', nome: 'TRANSPORTE' }, { id: 'instalado', nome: 'INSTALAÇÃO' }];
    const STATUS_ITEM_MAP = { 'nao-iniciado': { texto: 'Não iniciado', classe: 'status-item-nao-iniciado' }, 'iniciado': { texto: 'Iniciado', classe: 'status-item-iniciado' }, 'parado': { texto: 'Parado', classe: 'status-item-parado' }, 'concluido': { texto: 'Concluído', classe: 'status-item-concluido' }, 'cancelado': { texto: 'Cancelado', classe: 'status-item-cancelado' }, 'default': { texto: 'Não iniciado', classe: 'status-item-nao-iniciado' } };
    const STATUS_MATERIAL_MAP = { 
        'naoIniciado': { texto: 'Não Iniciado', classe: 'status-item-nao-iniciado' },
        'conferenciaEstoque': { texto: 'Conferência Estoque', classe: 'status-mat-conferenciaEstoque' }, 
        'emCotacao': { texto: 'Em cotação', classe: 'status-mat-emCotacao' }, 
        'compraParcial': { texto: 'Compra Parcial', classe: 'status-mat-compraParcial' }, 
        'compraTotal': { texto: 'Compra Total', classe: 'status-mat-compraTotal' }, 
        'recebidoParcial': { texto: 'Recebido Parcial', classe: 'status-mat-recebidoParcial' }, 
        'recebidoTotal': { texto: 'Recebido Total', classe: 'status-mat-recebidoTotal' }, 
        'conferidoFalta': { texto: 'Conferido Falta', classe: 'status-mat-conferidoFalta' }, 
        'conferidoParcial': { texto: 'Conferido Parcial', classe: 'status-mat-conferidoParcial' }, 
        'conferidoTotal': { texto: 'Conferido Total', classe: 'status-mat-conferidoTotal' }, 
        'alocadoParcial': { texto: 'Alocado Parcial', classe: 'status-mat-alocadoParcial' }, 
        'alocadoTotal': { texto: 'Alocado Total', classe: 'status-mat-alocadoTotal' }, 
        'cancelado': { texto: 'Cancelado', classe: 'status-mat-cancelado' }, 
        'default': { texto: 'Não Iniciado', classe: 'status-item-nao-iniciado' } 
    };
    const TIPO_ITEM_STYLE_MAP = { 'Projeto': 'bg-blue-100 text-blue-800', 'Orçamento': 'bg-green-100 text-green-800', 'Revisão': 'bg-fuchsia-100 text-fuchsia-800', 'Terceiros': 'bg-purple-100 text-purple-800', 'Compra Inicial': 'bg-orange-100 text-orange-800' };

    // --- VARIÁVEIS DE ESTADO ---
    let obras = [];
    let uiState = {};
    let edicaoAtual = { obraId: null, itemId: null, materialId: null, etapaId: null };
    let edicaoItemAtual = { obraId: null, itemId: null };
    let edicaoMaterialAtual = { obraId: null, itemId: null, materialId: null };
    let edicaoObraAtual = { obraId: null };
    let isFormularioNovaObraVisivel = false;
    let filtros = {};

    // --- REFERÊNCIAS DE ELEMENTOS DO DOM ---
    const obrasContainer = document.getElementById('obras-container');
    const modal = document.getElementById('status-modal');
    const modalContent = modal.querySelector('.modal-content');
    const editItemModal = document.getElementById('edit-item-modal');
    const editItemModalContent = editItemModal.querySelector('.modal-content');
    const editMaterialModal = document.getElementById('edit-material-modal');
    const editMaterialModalContent = editMaterialModal.querySelector('.modal-content');
    const editObraModal = document.getElementById('edit-obra-modal');
    const editObraModalContent = editObraModal.querySelector('.modal-content');
    const formNovaObraContainer = document.getElementById('form-nova-obra-container');
    const btnToggleFormObra = document.getElementById('btn-toggle-form-obra');

    // --- FUNÇÕES DE DADOS (FIREBASE) ---
    const escutarObras = () => {
        onSnapshot(obrasCollection, (querySnapshot) => {
            const obrasTemp = [];
            querySnapshot.forEach((doc) => {
                obrasTemp.push({ id: doc.id, ...doc.data() });
            });
            obras = obrasTemp;
            aplicarFiltrosERenderizar();
        }, (error) => {
            console.error("Erro ao buscar obras do Firestore: ", error);
            obrasContainer.innerHTML = `<div class="text-center p-8 bg-white rounded-lg border border-gray-200"><h3 class="text-lg font-medium text-red-700">Erro ao carregar dados.</h3><p class="text-gray-500 mt-1">Não foi possível conectar ao banco de dados.</p></div>`;
        });
    };

    // --- AUTENTICAÇÃO ANÔNIMA ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Usuário autenticado:", user.uid);
            escutarObras();
        } else {
            signInAnonymously(auth).catch((error) => {
                console.error("Erro na autenticação anônima:", error);
            });
        }
    });

    // --- FUNÇÕES DE RENDERIZAÇÃO E UTILITÁRIOS ---
    const formatarData = (dataString) => dataString ? new Date(dataString + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' }) : '---';

    const calcularTotaisItens = (obra) => {
        const etapaProducaoId = 'emProducao';
        if (!obra.itens) return { concluidas: 0, total: 0 };
        const itensContaveis = obra.itens.filter(item => item.tipo === 'Projeto' || item.tipo === 'Terceiros');
        const itensAtivos = itensContaveis.filter(item => item.etapas[etapaProducaoId]?.status !== 'cancelado');
        const totalItensAtivos = itensAtivos.length;
        if (totalItensAtivos === 0) return { concluidas: 0, total: 0 };
        const itensConcluidos = itensAtivos.filter(item => item.etapas[etapaProducaoId]?.status === 'concluido').length;
        return { concluidas: itensConcluidos, total: totalItensAtivos };
    };

    const aplicarFiltrosERenderizar = () => {
        let obrasFiltradas = [...obras];
        const nomeObraFiltro = filtros.nomeObra?.toLowerCase();
        if (nomeObraFiltro) {
            obrasFiltradas = obrasFiltradas.filter(obra =>
                obra.nome.toLowerCase().includes(nomeObraFiltro) ||
                obra.cliente.toLowerCase().includes(nomeObraFiltro)
            );
        }
        const tipoItemFiltro = filtros.tipoItem || [];
        const statusMaterialFiltro = filtros.statusMaterial || [];
        const statusItemFiltros = filtros.statusItem || {};
        const estoqueFiltro = filtros.estoque;
        const temFiltroDeItem = tipoItemFiltro.length > 0 || statusMaterialFiltro.length > 0 || !!estoqueFiltro || Object.values(statusItemFiltros).some(v => v !== 'todos');
        
        if (temFiltroDeItem) {
            obrasFiltradas = obrasFiltradas.map(obra => {
                if (!obra.itens) return { ...obra, itens: [] };
                const itensFiltrados = obra.itens.filter(item => {
                    if (tipoItemFiltro.length > 0 && !tipoItemFiltro.includes(item.tipo)) return false;
                    
                    for (const etapaId in statusItemFiltros) {
                        const statusFiltro = statusItemFiltros[etapaId];
                        if (statusFiltro !== 'todos') {
                            const itemStatus = item.etapas[etapaId]?.status || 'nao-iniciado';
                            if (itemStatus !== statusFiltro) return false;
                        }
                    }
                    
                    if (statusMaterialFiltro.length > 0 || estoqueFiltro) {
                        const temMaterialCorrespondente = (item.materiais || []).some(mat => {
                            const statusMatch = statusMaterialFiltro.length === 0 || statusMaterialFiltro.includes(mat.statusInfo?.status || 'naoIniciado');
                            
                            const temDataEstoque = mat.statusInfo?.statusDates?.conferenciaEstoque;
                            let estoqueMatch = true;
                            if (estoqueFiltro === 'S') {
                                estoqueMatch = !!temDataEstoque;
                            } else if (estoqueFiltro === 'N') {
                                estoqueMatch = !temDataEstoque;
                            }

                            return statusMatch && estoqueMatch;
                        });
                        if (!temMaterialCorrespondente) return false;
                    }
                    
                    return true;
                });
                return { ...obra, itens: itensFiltrados };
            }).filter(obra => obra.itens.length > 0);
        }
        renderizarObras(obrasFiltradas);
    }

    const renderizarObras = (listaObras = obras) => {
        obrasContainer.innerHTML = listaObras.length === 0
            ? `<div class="text-center p-8 bg-white rounded-lg border border-gray-200"><h3 class="text-lg font-medium text-gray-700">Nenhuma obra encontrada.</h3><p class="text-gray-500 mt-1">Ajuste os filtros ou adicione uma nova obra.</p></div>`
            : listaObras.map(obra => {
                const totais = calcularTotaisItens(obra);
                const estadoUIObra = uiState[obra.id] || { dadosExpanded: false, isExpanded: false, itemExpandidoId: null };
                const dadosHtml = estadoUIObra.dadosExpanded ? `
                    <div class="border-t pt-4 mt-4">
                        <div class="mb-4">
                            <p class="text-sm text-gray-800"><strong class="font-semibold">Cliente:</strong> ${obra.cliente}</p>
                            <p class="text-sm text-gray-600">${obra.endereco || 'Endereço não informado'}</p>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-gray-700">MEDIÇÃO</h4>
                                <p class="text-sm text-gray-600">Prev. Inicial: <span class="font-medium">${formatarData(obra.previsaoInicialMedicao)}</span></p>
                                <p class="text-sm text-gray-600">Nova Previsão: <span class="font-medium">${formatarData(obra.novaPrevisaoMedicao)}</span></p>
                                <p class="text-sm text-gray-600">Realizada: <span class="font-medium">${formatarData(obra.medicaoEfetuada)}</span></p>
                                <p class="text-xs text-gray-500 mt-1 whitespace-pre-wrap">${obra.obsMedicao || ' '}</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-700">FINALIZAÇÃO</h4>
                                <p class="text-sm text-gray-600">Prev. Inicial: <span class="font-medium">${formatarData(obra.previsaoInicialEntrega)}</span></p>
                                <p class="text-sm text-gray-600">Nova Previsão: <span class="font-medium">${formatarData(obra.novaPrevisaoEntrega)}</span></p>
                                <p class="text-sm text-gray-600">Realizada: <span class="font-medium">${formatarData(obra.entregaRealizada)}</span></p>
                                <p class="text-xs text-gray-500 mt-1 whitespace-pre-wrap">${obra.obsEntrega || ' '}</p>
                            </div>
                        </div>
                    </div>` : '';
                const itensHtml = estadoUIObra.isExpanded ? `
                    <div class="table-container -mx-3 mt-4">
                        <table class="min-w-full">
                            <thead id="header-itens-${obra.id}"></thead>
                            <tbody class="itens-container" data-obra-id="${obra.id}">${renderizarItens(obra)}</tbody>
                        </table>
                    </div>
                    <div class="mt-6 flex flex-col gap-4 px-3">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <select class="input-add-item-tipo p-3 border rounded-lg w-full sm:w-auto" data-obra-id="${obra.id}">
                                <option value="Projeto">Projeto</option>
                                <option value="Orçamento">Orçamento</option>
                                <option value="Revisão">Revisão</option>
                                <option value="Terceiros">Terceiros</option>
                                <option value="Compra Inicial">Compra Inicial</option>
                            </select>
                            <input type="text" placeholder="Código do Item" class="input-add-item-codigo p-3 border rounded-lg w-full sm:w-1/4" data-obra-id="${obra.id}">
                            <input type="text" placeholder="Descrição do novo item" class="input-add-item-descricao flex-grow p-3 border rounded-lg" data-obra-id="${obra.id}">
                        </div>
                        <div id="add-item-projeto-fields-${obra.id}" class="grid-cols-2 md:grid-cols-3 gap-4 hidden">
                            <input type="text" placeholder="Largura" class="input-add-item-largura p-3 border rounded-lg" data-obra-id="${obra.id}"><input type="text" placeholder="Altura" class="input-add-item-altura p-3 border rounded-lg" data-obra-id="${obra.id}"><input type="text" placeholder="M² Total" class="input-add-item-m2-total p-3 border rounded-lg" data-obra-id="${obra.id}"><input type="text" placeholder="Cor" class="input-add-item-cor p-3 border rounded-lg" data-obra-id="${obra.id}"><input type="text" placeholder="Vidro" class="input-add-item-vidro p-3 border rounded-lg" data-obra-id="${obra.id}"><input type="text" placeholder="M² Vidro" class="input-add-item-m2-vidro p-3 border rounded-lg" data-obra-id="${obra.id}">
                        </div>
                        <div id="add-item-orcamento-revisao-fields-${obra.id}" class="hidden flex-wrap gap-4 items-center">
                            <div id="add-orcamento-fields-container-${obra.id}" class="hidden">
                                <input type="number" placeholder="Qtd Peças" class="input-add-item-qtd-pecas p-3 border rounded-lg" data-obra-id="${obra.id}">
                            </div>
                            <div id="add-revisao-fields-container-${obra.id}" class="hidden flex flex-wrap gap-4 items-center">
                                <input type="text" placeholder="Versão" class="input-add-item-versao p-3 border rounded-lg" data-obra-id="${obra.id}">
                                <div class="flex items-center">
                                    <input type="checkbox" id="add-item-revisao-check-${obra.id}" class="input-add-item-revisao-check h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" data-obra-id="${obra.id}">
                                    <label for="add-item-revisao-check-${obra.id}" class="ml-2 text-sm text-gray-700">Solicitada Alteração</label>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button class="btn-add-item bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800 flex-grow" data-obra-id="${obra.id}">Adicionar Item</button>
                            <div id="upload-itens-container-${obra.id}" class="hidden">
                                <label for="upload-itens-${obra.id}" class="block text-center bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 cursor-pointer">Carregar Itens (XLSX)</label>
                                <input type="file" id="upload-itens-${obra.id}" class="hidden" accept=".xlsx, .xls" data-obra-id="${obra.id}">
                            </div>
                        </div>
                    </div>` : '';
                return `
                <div class="bg-white rounded-xl border border-gray-200 py-2 px-3">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-start">
                        <div class="flex-grow">
                            <div class="flex items-center gap-4 mb-1">
                                <h2 class="text-base font-bold text-gray-800">${obra.nome} <span class="text-sm font-medium text-gray-600">- ${obra.cliente}</span></h2>
                                <div class="bg-gray-100 text-gray-800 font-bold text-base py-1 px-3 rounded-lg" title="Itens de Projeto/Terceiros Concluídos na Produção / Total de Itens Ativos">
                                    <span>${totais.concluidas}</span> / <span>${totais.total}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-center items-center gap-3 mt-4 sm:mt-0 flex-shrink-0">
                             <button title="Mostrar/Ocultar Dados" class="btn-toggle-dados action-btn bg-green-500 text-white font-semibold text-xs px-2 py-1" data-obra-id="${obra.id}">DADOS</button>
                             <button title="${estadoUIObra.isExpanded ? 'Ocultar Itens' : 'Mostrar Itens'}" class="btn-toggle-itens action-btn bg-blue-500 text-white" data-obra-id="${obra.id}">${estadoUIObra.isExpanded ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>'}</button>
                             <button title="Alterar Obra" class="btn-alterar-obra action-btn bg-yellow-400 text-white" data-obra-id="${obra.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                             <button title="Excluir Obra" class="btn-excluir-obra action-btn bg-red-500 text-white" data-obra-id="${obra.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>
                    ${dadosHtml}
                    ${itensHtml}
                </div>`
            }).join('');
        listaObras.forEach(obra => {
            if (uiState[obra.id]?.isExpanded) {
                renderizarHeaderItens(obra);
                const tipoSelect = document.querySelector(`.input-add-item-tipo[data-obra-id="${obra.id}"]`);
                if(tipoSelect) {
                    toggleProjetoFields(tipoSelect.value, obra.id);
                    toggleOrcamentoRevisaoFields(tipoSelect.value, obra.id);
                }
            }
        });
    };

    const renderizarHeaderItens = (obra) => {
        const header = document.getElementById(`header-itens-${obra.id}`);
        if (!header) return;
        const splitIndex = ETAPAS_ITEM.findIndex(e => e.id === 'emProducao');
        const primeiraParteEtapas = ETAPAS_ITEM.slice(0, splitIndex);
        const segundaParteEtapas = ETAPAS_ITEM.slice(splitIndex);
        header.innerHTML = `<tr class="border-b">
                <th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase sticky left-0 bg-white z-10 w-1/4">Item</th>
                ${primeiraParteEtapas.map(e => `<th class="p-3 text-center text-xs font-semibold text-gray-500 uppercase">${e.nome}</th>`).join('')}
                <th class="p-3 text-center text-xs font-semibold text-gray-500 uppercase">Materiais</th>
                ${segundaParteEtapas.map(e => `<th class="p-3 text-center text-xs font-semibold text-gray-500 uppercase">${e.nome}</th>`).join('')}
                <th class="p-3 text-center text-xs font-semibold text-gray-500 uppercase">Ações</th>
            </tr>`;
    };

    const renderizarEtapaItem = (obraId, itemId, etapa) => {
        const obra = obras.find(o => o.id === obraId);
        const item = obra.itens.find(p => p.id === itemId);
        if (!item) return '<td></td>';
        if (item.tipo === 'Compra Inicial') return `<td class="p-3 text-center text-gray-300">-</td>`;
        if ((item.tipo === 'Projeto' || item.tipo === 'Terceiros') && etapa.id === 'alteracaoProjeto') return `<td class="p-3 text-center text-gray-300">-</td>`;
        if ((item.tipo === 'Orçamento' || item.tipo === 'Revisão') && etapa.id !== 'alteracaoProjeto') return `<td class="p-3 text-center text-gray-300">-</td>`;
        
        const statusInfo = item.etapas[etapa.id];
        const statusData = statusInfo ? STATUS_ITEM_MAP[statusInfo.status] || STATUS_ITEM_MAP['default'] : STATUS_ITEM_MAP['default'];
        const dataFormatada = statusInfo?.data ? formatarData(statusInfo.data) : '';
        const prazoFormatado = statusInfo?.prazoConclusaoReagendado ? formatarData(statusInfo.prazoConclusaoReagendado) : (statusInfo?.prazoConclusaoInicial ? formatarData(statusInfo.prazoConclusaoInicial) : '');

        let dataFinalFormatada = '';
        if(etapa.id === 'alteracaoProjeto' || etapa.id === 'projetoFinal') dataFinalFormatada = statusInfo?.conclusaoFinal ? formatarData(statusInfo.conclusaoFinal) : '';
        if(etapa.id === 'emProducao') dataFinalFormatada = statusInfo?.conclusaoEfetiva ? formatarData(statusInfo.conclusaoEfetiva) : '';
        if(etapa.id === 'entregue') dataFinalFormatada = statusInfo?.entregaFinal ? formatarData(statusInfo.entregaFinal) : '';
        if(etapa.id === 'instalado') dataFinalFormatada = statusInfo?.instalacaoFinal ? formatarData(statusInfo.instalacaoFinal) : '';
        
        let statusTextStyle = '';
        if (prazoFormatado && statusInfo.status !== 'concluido' && statusInfo.status !== 'cancelado') {
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            const prazoDate = new Date((statusInfo.prazoConclusaoReagendado || statusInfo.prazoConclusaoInicial) + 'T00:00:00');
            if (prazoDate < hoje) statusTextStyle = 'color: #dc2626; font-weight: bold;';
        }

        let tooltipText = statusInfo?.observacao || 'Sem observações';
        if (prazoFormatado) { tooltipText += `\nPrazo: ${prazoFormatado}`; }
        if(dataFinalFormatada) { tooltipText += `\nConclusão: ${dataFinalFormatada}`;}

        return `<td class="p-3 text-center">
            <div class="status-badge rounded-lg p-2 text-sm font-semibold ${statusData.classe}" data-obra-id="${obraId}" data-item-id="${item.id}" data-etapa-id="${etapa.id}" title="${tooltipText}">
                <span style="${statusTextStyle}">${statusData.texto}</span>
                ${dataFormatada ? `<div class="text-xs font-normal">Data: ${dataFormatada}</div>` : ''}
                ${dataFinalFormatada ? `<div class="text-xs font-normal" style="color: #166534; font-weight: bold;">Final: ${dataFinalFormatada}</div>` : ''}
                ${prazoFormatado ? `<div class="text-xs font-normal">Prazo: ${prazoFormatado}</div>` : ''}
            </div>
        </td>`;
    };

	const renderizarAcoesItem = (obra, item) => `
        <td class="p-3 text-center">
            <div class="flex justify-center items-center gap-3">
                 <button title="Alterar Item" class="btn-alterar-item action-btn bg-yellow-400 text-white" data-obra-id="${obra.id}" data-item-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                 <button title="Excluir Item" class="btn-excluir-item action-btn bg-red-500 text-white" data-obra-id="${obra.id}" data-item-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
            </div>
        </td>`;

    const getBotaoMateriaisState = (materiais) => {
        const materiaisAtivos = (materiais || []).filter(mat => mat.statusInfo?.status !== 'cancelado');
        const totalMateriaisAtivos = materiaisAtivos.length;
        if (totalMateriaisAtivos === 0) return { text: '0/0', className: 'bg-gray-200 text-gray-700' };
        let alocadosCount = 0, naoIniciadoCount = 0, hasConferidoFalta = false;
        for (const mat of materiaisAtivos) {
            const status = mat.statusInfo?.status || 'naoIniciado';
            if (status === 'alocadoTotal') alocadosCount++;
            if (status === 'naoIniciado') naoIniciadoCount++;
            if (status === 'conferidoFalta') hasConferidoFalta = true;
        }
        const text = `${alocadosCount}/${totalMateriaisAtivos}`;
        let className = '';
        if (hasConferidoFalta) className = 'bg-red-500 text-white hover:bg-red-600';
        else if (alocadosCount === totalMateriaisAtivos && totalMateriaisAtivos > 0) className = 'bg-green-500 text-white hover:bg-green-600';
        else if (naoIniciadoCount === totalMateriaisAtivos) className = 'bg-white text-gray-800 border border-gray-300 hover:bg-gray-100';
        else className = 'bg-yellow-400 text-white hover:bg-yellow-500';
        return { text, className };
    };

    const renderizarItens = (obra) => {
        if (!obra.itens || obra.itens.length === 0) return `<tr><td colspan="100%" class="p-4 text-center text-gray-500">Nenhum item adicionado.</td></tr>`;
        const itemExpandidoId = uiState[obra.id]?.itemExpandidoId;
        const splitIndex = ETAPAS_ITEM.findIndex(e => e.id === 'emProducao');
        const primeiraParteEtapas = ETAPAS_ITEM.slice(0, splitIndex);
        const segundaParteEtapas = ETAPAS_ITEM.slice(splitIndex);
        return obra.itens.map(item => {
            const tipoStyle = TIPO_ITEM_STYLE_MAP[item.tipo] || 'bg-gray-100 text-gray-800';
            let materiaisCell = `<td class="p-3 text-center text-gray-300">-</td>`;
            if (item.tipo === 'Projeto' || item.tipo === 'Terceiros' || item.tipo === 'Compra Inicial') {
                const botaoState = getBotaoMateriaisState(item.materiais);
                const buttonText = itemExpandidoId === item.id ? 'Fechar' : botaoState.text;
                materiaisCell = `<td class="p-3 text-center"><button class="btn-toggle-materiais text-sm font-semibold py-1 px-3 rounded-md ${botaoState.className}" data-obra-id="${obra.id}" data-item-id="${item.id}">${buttonText}</button></td>`;
            }
            const projetoFieldsHtml = item.tipo === 'Projeto' ? `
                <div class="mt-2 p-2 bg-gray-50 rounded-md text-xs grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-1">
                    <p><strong>Largura:</strong> ${item.largura || '---'}</p><p><strong>Altura:</strong> ${item.altura || '---'}</p><p><strong>M² Total:</strong> ${item.m2Total || '---'}</p><p><strong>Cor:</strong> ${item.cor || '---'}</p><p><strong>Vidro:</strong> ${item.vidro || '---'}</p><p><strong>M² Vidro:</strong> ${item.m2Vidro || '---'}</p>
                </div>` : '';
            const orcamentoRevisaoFieldsHtml = item.tipo === 'Orçamento' ? `
                <div class="mt-2 p-2 bg-green-50 rounded-md text-xs">
                    <p><strong>Qtd Peças:</strong> ${item.qtdPecas || '---'}</p>
                </div>` : item.tipo === 'Revisão' ? `
                <div class="mt-2 p-2 bg-fuchsia-50 rounded-md text-xs grid grid-cols-2 gap-x-4">
                    <p><strong>Versão:</strong> ${item.versao || '---'}</p>
                    <p><strong>Alteração Solicitada:</strong> ${item.revisaoAprovada ? 'Sim' : 'Não'}</p>
                </div>` : '';

            return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium text-gray-800 sticky left-0 bg-white hover:bg-gray-50 z-10">
                        <div>
                            <div class="flex items-center space-x-2"><span class="font-bold text-gray-900">${item.codigo}</span><span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tipoStyle}">${item.tipo}</span></div>
                            <p class="text-sm text-gray-600">${item.descricao}</p>
                            ${projetoFieldsHtml}
                            ${orcamentoRevisaoFieldsHtml}
                        </div>
                    </td>
                    ${primeiraParteEtapas.map(etapa => renderizarEtapaItem(obra.id, item.id, etapa)).join('')}
                    ${materiaisCell}
                    ${segundaParteEtapas.map(etapa => renderizarEtapaItem(obra.id, item.id, etapa)).join('')}
                    ${renderizarAcoesItem(obra, item)}
                </tr>
                ${itemExpandidoId === item.id ? renderizarMateriais(obra, item) : ''}`;
        }).join('');
    };

    const renderizarMateriais = (obra, item) => {
        let additionalHeaders = '', additionalInputsHtml = '';
        if (item.tipo === 'Compra Inicial' || item.tipo === 'Projeto') {
            additionalHeaders = `<th class="p-2 text-center text-xs font-semibold text-gray-500">Estoque</th><th class="p-2 text-left text-xs font-semibold text-gray-500">Orçado</th><th class="p-2 text-left text-xs font-semibold text-gray-500">Disp.</th><th class="p-2 text-center text-xs font-semibold text-gray-500">%</th>`;
            additionalInputsHtml = `<input type="number" placeholder="Qtde Orçada" class="input-material-qtde-orcada flex-grow p-2 border rounded-md focus:border-blue-500 focus:ring-0" data-item-id="${item.id}"><input type="number" placeholder="Qtde Disponível" class="input-material-qtde-disponivel flex-grow p-2 border rounded-md focus:border-blue-500 focus:ring-0" data-item-id="${item.id}">`;
        }
        const renderAdditionalCells = (mat) => {
            if (item.tipo === 'Compra Inicial' || item.tipo === 'Projeto') {
                const qtdeOrcada = parseFloat(mat.qtdeOrcada) || 0, qtdeDisponivel = parseFloat(mat.qtdeDisponivel) || 0;
                const percentual = qtdeOrcada > 0 ? Math.round((qtdeDisponivel / qtdeOrcada) * 100) : 0;
                const barWidth = Math.min(100, percentual); let hue = (barWidth / 100) * 120;
                const isEstoqueChecked = mat.statusInfo?.statusDates?.conferenciaEstoque ? 'checked' : '';
                return `<td class="p-2 text-center align-middle"><input type="checkbox" class="h-4 w-4 rounded" ${isEstoqueChecked} disabled></td><td class="p-2 text-gray-600">${mat.qtdeOrcada || ''}</td><td class="p-2 text-gray-600">${mat.qtdeDisponivel || ''}</td><td class="p-2"><div class="progress-bar-container bg-gray-300 rounded-full h-4 w-full"><div class="h-full rounded-full transition-all duration-500" style="width: ${barWidth}%; background-color: hsl(${hue}, 80%, 40%);"></div><span class="progress-bar-text text-xs font-bold">${percentual}%</span></div></td>`;
            } return '';
        };
        
        let materiaisParaRenderizar = item.materiais || [];
        const statusMaterialFiltro = filtros.statusMaterial || [];
        const estoqueFiltro = filtros.estoque;

        if (statusMaterialFiltro.length > 0 || estoqueFiltro) {
            materiaisParaRenderizar = materiaisParaRenderizar.filter(mat => {
                const statusMatch = statusMaterialFiltro.length === 0 || statusMaterialFiltro.includes(mat.statusInfo?.status || 'naoIniciado');
                
                const temDataEstoque = mat.statusInfo?.statusDates?.conferenciaEstoque;
                let estoqueMatch = true;
                if (estoqueFiltro === 'S') {
                    estoqueMatch = !!temDataEstoque;
                } else if (estoqueFiltro === 'N') {
                    estoqueMatch = !temDataEstoque;
                }

                return statusMatch && estoqueMatch;
            });
        }

        return `<tr class="materiais-row"><td colspan="100%" class="bg-gray-100 p-4"><div class="p-4"><h4 class="font-bold text-gray-700 mb-3">Materiais: ${item.codigo} - ${item.descricao}</h4><div class="table-container"><table class="min-w-full bg-white rounded-lg"><thead><tr class="border-b"><th class="p-2 text-left text-xs font-semibold text-gray-500">Tipo</th><th class="p-2 text-left text-xs font-semibold text-gray-500">Descrição</th>${additionalHeaders}<th class="p-2 text-left text-xs font-semibold text-gray-500">Prev. Inicial</th><th class="p-2 text-left text-xs font-semibold text-gray-500">Prev. Reag.</th><th class="p-2 text-left text-xs font-semibold text-gray-500">Disp. Total</th><th class="p-2 text-center text-xs font-semibold text-gray-500">Status</th><th class="p-2 text-center text-xs font-semibold text-gray-500">Ação</th></tr></thead><tbody>
                ${(materiaisParaRenderizar).map(mat => {
                    const statusInfo = mat.statusInfo || {}, statusData = statusInfo.status ? STATUS_MATERIAL_MAP[statusInfo.status] : STATUS_MATERIAL_MAP['default'];
                    return `<tr class="border-b"><td class="p-2 font-medium text-gray-800">${mat.tipo}</td><td class="p-2 text-gray-600">${mat.descricao}</td>${renderAdditionalCells(mat)}<td class="p-2 text-gray-600 text-xs">${formatarData(statusInfo.previsaoDisponibilidadeInicial)}</td><td class="p-2 text-gray-600 text-xs">${formatarData(statusInfo.previsaoDisponibilidadeReagendado)}</td><td class="p-2 text-gray-600 text-xs">${formatarData(statusInfo.disponibilidadeTotal)}</td><td class="p-2 text-center"><div class="status-badge rounded-md ${statusData.classe} material-status-badge" data-obra-id="${obra.id}" data-item-id="${item.id}" data-material-id="${mat.id}" title="${statusInfo.observacao || ''}">${statusData.texto}</div></td><td class="p-2"><div class="flex justify-center items-center gap-3"><button title="Alterar Material" class="btn-alterar-material action-btn bg-yellow-400 text-white" data-obra-id="${obra.id}" data-item-id="${item.id}" data-material-id="${mat.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button title="Excluir Material" class="btn-excluir-material action-btn bg-red-500 text-white" data-obra-id="${obra.id}" data-item-id="${item.id}" data-material-id="${mat.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div></td></tr>`;
                }).join('')}
                </tbody></table></div><div class="mt-4 flex flex-col sm:flex-row gap-2 flex-wrap items-center"><input type="text" placeholder="Tipo (ex: Perfil)" class="input-material-tipo flex-grow p-2 border rounded-md focus:border-blue-500 focus:ring-0" data-item-id="${item.id}"><input type="text" placeholder="Descrição (ex: PVC Branco)" class="input-material-desc flex-grow p-2 border rounded-md focus:border-blue-500 focus:ring-0" data-item-id="${item.id}">${additionalInputsHtml}<button class="btn-add-material bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600" data-obra-id="${obra.id}" data-item-id="${item.id}">Adicionar</button><label for="upload-materiais-${item.id}" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-teal-600 cursor-pointer">Importar Material</label><input type="file" id="upload-materiais-${item.id}" class="hidden" accept=".xlsx, .xls" data-obra-id="${obra.id}" data-item-id="${item.id}"></div></div></td></tr>`;
    }

    // --- FUNÇÕES DE MODAL ---
    const abrirModal = (obraId, itemId, etapaId, materialId) => {
        edicaoAtual = { obraId, itemId, etapaId, materialId };
        const obra = obras.find(o => o.id === obraId); if (!obra) return;
        const item = obra.itens.find(p => p.id === itemId); if (!item) return;
        const isMaterial = !!materialId;
        const targetItem = isMaterial ? (item.materiais || []).find(m => m.id === materialId) : item; if (!targetItem) return;
        
        const statusContainer = document.getElementById('modal-status-container');
        statusContainer.innerHTML = ''; 

        const newStatusContainer = statusContainer.cloneNode(true);
        statusContainer.parentNode.replaceChild(newStatusContainer, statusContainer);

        const statusMap = isMaterial ? STATUS_MATERIAL_MAP : STATUS_ITEM_MAP;
        
        let itemStatus = isMaterial ? (targetItem.statusInfo || {}) : (targetItem.etapas[etapaId] || {});
        let statusAtual = itemStatus.status || (isMaterial ? 'naoIniciado' : 'nao-iniciado');
        
        let statusDates = itemStatus.statusDates || {};
        if (!statusDates[statusAtual] && itemStatus.data) {
             statusDates[statusAtual] = itemStatus.data;
        }

        Object.keys(statusMap).filter(key => key !== 'default').forEach(key => {
            const statusInfo = statusMap[key];
            const isChecked = statusAtual === key;
            const dateValue = statusDates[key] || (isChecked ? itemStatus.data : '') || '';
            
            const elementHtml = `
                <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                    <div class="flex items-center">
                        <input type="radio" id="status-radio-${key}" name="modal-status-radio" value="${key}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" ${isChecked ? 'checked' : ''}>
                        <label for="status-radio-${key}" class="ml-3 text-sm font-medium text-gray-800">${statusInfo.texto}</label>
                    </div>
                    <input type="date" value="${dateValue}" class="p-1 border rounded-md text-sm w-36 status-date-input" data-status-key="${key}">
                </div>
            `;
            newStatusContainer.innerHTML += elementHtml;
        });

        document.getElementById('modal-header').textContent = `Atualizar Status de ${isMaterial ? 'Material' : 'Item'}`;
        document.getElementById('modal-item-nome').textContent = isMaterial ? `${targetItem.tipo}: ${targetItem.descricao}` : `${targetItem.codigo}: ${targetItem.descricao}`;

        const prazoContainer = document.getElementById('modal-prazo-container');
        const previsaoContainer = document.getElementById('modal-previsao-container');
        const conclusaoEfetivaContainer = document.getElementById('modal-conclusao-efetiva-container');
        const conclusaoFinalContainer = document.getElementById('modal-conclusao-final-container');
        const entregaFinalContainer = document.getElementById('modal-entrega-final-container');
        const instalacaoFinalContainer = document.getElementById('modal-instalacao-final-container');

        [prazoContainer, previsaoContainer, conclusaoEfetivaContainer, conclusaoFinalContainer, entregaFinalContainer, instalacaoFinalContainer].forEach(el => el.classList.add('hidden'));

        const updateFinalDates = () => {
            const selectedStatusRadio = newStatusContainer.querySelector('input[name="modal-status-radio"]:checked');
            if (!selectedStatusRadio) return;
            const selectedStatus = selectedStatusRadio.value;

            if (isMaterial) {
                const alocadoTotalDateInput = newStatusContainer.querySelector('.status-date-input[data-status-key="alocadoTotal"]');
                const disponibilidadeTotalInput = document.getElementById('modal-disponibilidade-total');
                disponibilidadeTotalInput.value = (selectedStatus === 'alocadoTotal') ? alocadoTotalDateInput.value : '';
            } else {
                const concluidoDateInput = newStatusContainer.querySelector('.status-date-input[data-status-key="concluido"]');
                const updateValue = (selectedStatus === 'concluido') ? concluidoDateInput.value : '';
                
                if (etapaId === 'alteracaoProjeto' || etapaId === 'projetoFinal') {
                    document.getElementById('modal-conclusao-final').value = updateValue;
                } else if (etapaId === 'emProducao') {
                    document.getElementById('modal-conclusao-efetiva').value = updateValue;
                } else if (etapaId === 'entregue') {
                    document.getElementById('modal-entrega-final').value = updateValue;
                } else if (etapaId === 'instalado') {
                    document.getElementById('modal-instalacao-final').value = updateValue;
                }
            }
        };

        newStatusContainer.addEventListener('change', (e) => {
            if (e.target.name === 'modal-status-radio') {
                updateFinalDates();
            }
        });
        newStatusContainer.addEventListener('input', (e) => {
            if (e.target.classList.contains('status-date-input')) {
                const statusKey = e.target.dataset.statusKey;
                if ((isMaterial && statusKey === 'alocadoTotal') || (!isMaterial && statusKey === 'concluido')) {
                    updateFinalDates();
                }
            }
        });

        if (isMaterial) {
            document.getElementById('modal-etapa-container').style.display = 'none';
            previsaoContainer.classList.remove('hidden');

            const previsaoInicialInput = document.getElementById('modal-previsao-disponibilidade-inicial');
            previsaoInicialInput.value = itemStatus.previsaoDisponibilidadeInicial || '';
            previsaoInicialInput.disabled = !!itemStatus.previsaoDisponibilidadeInicial;
            
            document.getElementById('modal-previsao-disponibilidade-reagendado').value = itemStatus.previsaoDisponibilidadeReagendado || '';
            document.getElementById('modal-disponibilidade-total').value = itemStatus.disponibilidadeTotal || '';
        } else {
            document.getElementById('modal-etapa-container').style.display = 'inline';
            const etapa = ETAPAS_ITEM.find(e => e.id === etapaId);
            document.getElementById('modal-etapa-nome').textContent = etapa.nome;
            prazoContainer.classList.remove('hidden');

            const prazoInicialInput = document.getElementById('modal-prazo-inicial');
            prazoInicialInput.value = itemStatus.prazoConclusaoInicial || '';
            prazoInicialInput.disabled = !!itemStatus.prazoConclusaoInicial;
            document.getElementById('modal-prazo-reagendado').value = itemStatus.prazoConclusaoReagendado || '';

            if (etapaId === 'alteracaoProjeto' || etapaId === 'projetoFinal') {
                conclusaoFinalContainer.classList.remove('hidden');
                document.getElementById('modal-conclusao-final').value = itemStatus.conclusaoFinal || '';
            } else if (etapaId === 'emProducao') {
                conclusaoEfetivaContainer.classList.remove('hidden');
                document.getElementById('modal-conclusao-efetiva').value = itemStatus.conclusaoEfetiva || '';
            } else if (etapaId === 'entregue') {
                entregaFinalContainer.classList.remove('hidden');
                document.getElementById('modal-entrega-final').value = itemStatus.entregaFinal || '';
            } else if (etapaId === 'instalado') {
                instalacaoFinalContainer.classList.remove('hidden');
                document.getElementById('modal-instalacao-final').value = itemStatus.instalacaoFinal || '';
            }
        }
        
        document.getElementById('modal-obs').value = itemStatus.observacao || '';
        
        updateFinalDates();
        
        modal.classList.remove('hidden');
        setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
    };

    const fecharModal = () => { modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); };

    const salvarStatus = async () => {
        const { obraId, itemId, etapaId, materialId } = edicaoAtual;
        const obra = obras.find(o => o.id === obraId);
        const itemIndex = obra.itens.findIndex(p => p.id === itemId);
        
        const selectedRadio = document.querySelector('input[name="modal-status-radio"]:checked');
        if (!selectedRadio) {
            alert('Por favor, selecione um status.');
            return;
        }

        const novoStatus = selectedRadio.value;
        const dataInputs = document.querySelectorAll('.status-date-input');
        
        let dataDoStatus = '';
        const todasAsDatas = {};

        dataInputs.forEach(input => {
            const statusKey = input.dataset.statusKey;
            if(input.value) {
                todasAsDatas[statusKey] = input.value;
            }
            if (statusKey === novoStatus) {
                dataDoStatus = input.value;
            }
        });
        
        const dadosParaSalvar = {
            status: novoStatus,
            data: dataDoStatus,
            statusDates: todasAsDatas,
            observacao: document.getElementById('modal-obs').value.trim()
        };

        const obraDocRef = doc(db, 'obras', obraId);

        if (materialId) {
            const materialIndex = obra.itens[itemIndex].materiais.findIndex(m => m.id === materialId);
            const material = obra.itens[itemIndex].materiais[materialIndex];
            
            if (novoStatus === 'alocadoTotal') {
                const qtdeOrcada = parseFloat(material.qtdeOrcada) || 0;
                const qtdeDisponivel = parseFloat(material.qtdeDisponivel) || 0;

                if (qtdeDisponivel <= 0 || qtdeDisponivel !== qtdeOrcada) {
                    alert('O status "Alocado Total" só é permitido quando a "Qtde Disponível" é maior que zero e igual à "Qtde Orçada".');
                    return; 
                }
            }

            if (!document.getElementById('modal-previsao-disponibilidade-inicial').disabled) {
                dadosParaSalvar.previsaoDisponibilidadeInicial = document.getElementById('modal-previsao-disponibilidade-inicial').value;
            }
            dadosParaSalvar.previsaoDisponibilidadeReagendado = document.getElementById('modal-previsao-disponibilidade-reagendado').value;
            dadosParaSalvar.disponibilidadeTotal = document.getElementById('modal-disponibilidade-total').value;
            
            const oldStatusInfo = material.statusInfo || {};
            material.statusInfo = { ...oldStatusInfo, ...dadosParaSalvar };

        } else {
            if (!document.getElementById('modal-prazo-inicial').disabled) {
                dadosParaSalvar.prazoConclusaoInicial = document.getElementById('modal-prazo-inicial').value;
            }
            dadosParaSalvar.prazoConclusaoReagendado = document.getElementById('modal-prazo-reagendado').value;
            
            if (etapaId === 'alteracaoProjeto' || etapaId === 'projetoFinal') {
                dadosParaSalvar.conclusaoFinal = document.getElementById('modal-conclusao-final').value;
            } else if (etapaId === 'emProducao') {
                dadosParaSalvar.conclusaoEfetiva = document.getElementById('modal-conclusao-efetiva').value;
            } else if (etapaId === 'entregue') {
                dadosParaSalvar.entregaFinal = document.getElementById('modal-entrega-final').value;
            } else if (etapaId === 'instalado') {
                dadosParaSalvar.instalacaoFinal = document.getElementById('modal-instalacao-final').value;
            }
            
            obra.itens[itemIndex].etapas[etapaId] = {...obra.itens[itemIndex].etapas[etapaId], ...dadosParaSalvar};
        }

        await updateDoc(obraDocRef, { itens: obra.itens });
        fecharModal();
    };

    const abrirModalAlterarItem = (obraId, itemId) => {
        edicaoItemAtual = { obraId, itemId };
        const obra = obras.find(o => o.id === obraId);
        const item = obra.itens.find(p => p.id === itemId);
        const tipoSelect = document.getElementById('edit-item-tipo');
        tipoSelect.value = item.tipo;
        tipoSelect.disabled = true;
        document.getElementById('edit-item-codigo').value = item.codigo;
        document.getElementById('edit-item-descricao').value = item.descricao;
        
        toggleProjetoFieldsModal(item.tipo);
        toggleOrcamentoRevisaoFieldsModal(item.tipo);

        if (item.tipo === 'Projeto') {
            document.getElementById('edit-item-largura').value = item.largura || '';
            document.getElementById('edit-item-altura').value = item.altura || '';
            document.getElementById('edit-item-m2-total').value = item.m2Total || '';
            document.getElementById('edit-item-cor').value = item.cor || '';
            document.getElementById('edit-item-vidro').value = item.vidro || '';
            document.getElementById('edit-item-m2-vidro').value = item.m2Vidro || '';
        } else if (item.tipo === 'Orçamento') {
            document.getElementById('edit-item-qtd-pecas').value = item.qtdPecas || '';
        } else if (item.tipo === 'Revisão') {
            document.getElementById('edit-item-versao').value = item.versao || '';
            document.getElementById('edit-item-revisao-check').checked = item.revisaoAprovada || false;
        }

        editItemModal.classList.remove('hidden');
        setTimeout(() => { editItemModal.classList.remove('opacity-0'); }, 10);
    };

    const fecharModalAlterarItem = () => {
        document.getElementById('edit-item-tipo').disabled = false;
        editItemModal.classList.add('opacity-0');
        setTimeout(() => editItemModal.classList.add('hidden'), 200);
    };

    const salvarAlteracaoItem = async () => {
        const { obraId, itemId } = edicaoItemAtual;
        const obra = obras.find(o => o.id === obraId);
        const itemIndex = obra.itens.findIndex(p => p.id === itemId);
        const novoCodigo = document.getElementById('edit-item-codigo').value.trim();
        const novaDescricao = document.getElementById('edit-item-descricao').value.trim();
        if (novoCodigo && novaDescricao) {
            const item = obra.itens[itemIndex];
            item.codigo = novoCodigo;
            item.descricao = novaDescricao;
            if (item.tipo === 'Projeto') {
                item.largura = document.getElementById('edit-item-largura').value;
                item.altura = document.getElementById('edit-item-altura').value;
                item.m2Total = document.getElementById('edit-item-m2-total').value;
                item.cor = document.getElementById('edit-item-cor').value;
                item.vidro = document.getElementById('edit-item-vidro').value;
                item.m2Vidro = document.getElementById('edit-item-m2-vidro').value;
            } else if (item.tipo === 'Orçamento') {
                item.qtdPecas = document.getElementById('edit-item-qtd-pecas').value;
            } else if (item.tipo === 'Revisão') {
                item.versao = document.getElementById('edit-item-versao').value;
                item.revisaoAprovada = document.getElementById('edit-item-revisao-check').checked;
            }
            const obraDocRef = doc(db, 'obras', obraId);
            await updateDoc(obraDocRef, { itens: obra.itens });
            fecharModalAlterarItem();
        } else { alert('Código e Descrição não podem estar vazios.'); }
    };

    const abrirModalAlterarMaterial = (obraId, itemId, materialId) => {
        edicaoMaterialAtual = { obraId, itemId, materialId };
        const obra = obras.find(o => o.id === obraId);
        const item = obra.itens.find(p => p.id === itemId);
        const material = (item.materiais || []).find(m => m.id === materialId); if (!material) return;
        document.getElementById('edit-material-tipo').value = material.tipo;
        document.getElementById('edit-material-descricao').value = material.descricao;
        const compraFields = document.getElementById('edit-material-compra-fields');
        const showCompraFields = item.tipo === 'Compra Inicial' || item.tipo === 'Projeto';
        compraFields.classList.toggle('hidden', !showCompraFields);
        if (showCompraFields) {
            document.getElementById('edit-material-qtde-orcada').value = material.qtdeOrcada || '';
            document.getElementById('edit-material-qtde-disponivel').value = material.qtdeDisponivel || '';
        }
        editMaterialModal.classList.remove('hidden');
        setTimeout(() => { editMaterialModal.classList.remove('opacity-0'); }, 10);
    };

    const fecharModalAlterarMaterial = () => { editMaterialModal.classList.add('opacity-0'); setTimeout(() => editMaterialModal.classList.add('hidden'), 200); };

    const salvarAlteracaoMaterial = async () => {
        const { obraId, itemId, materialId } = edicaoMaterialAtual;
        const obra = obras.find(o => o.id === obraId);
        const itemIndex = obra.itens.findIndex(p => p.id === itemId);
        const materialIndex = obra.itens[itemIndex].materiais.findIndex(m => m.id === materialId);
        const novoTipo = document.getElementById('edit-material-tipo').value.trim();
        const novaDescricao = document.getElementById('edit-material-descricao').value.trim();
        if (novoTipo && novaDescricao) {
            const material = obra.itens[itemIndex].materiais[materialIndex];
            material.tipo = novoTipo;
            material.descricao = novaDescricao;
            if (obra.itens[itemIndex].tipo === 'Compra Inicial' || obra.itens[itemIndex].tipo === 'Projeto') {
                material.qtdeOrcada = document.getElementById('edit-material-qtde-orcada').value;
                material.qtdeDisponivel = document.getElementById('edit-material-qtde-disponivel').value;
            }
            const obraDocRef = doc(db, 'obras', obraId);
            await updateDoc(obraDocRef, { itens: obra.itens });
            fecharModalAlterarMaterial();
        } else { alert('Tipo e Descrição não podem estar vazios.'); }
    };

    const abrirModalAlterarObra = (obraId) => {
        edicaoObraAtual = { obraId };
        const obra = obras.find(o => o.id === obraId);
        document.getElementById('edit-obra-nome').value = obra.nome;
        document.getElementById('edit-obra-cliente').value = obra.cliente;
        document.getElementById('edit-obra-endereco').value = obra.endereco;
        const previsaoInicialMedicaoInput = document.getElementById('edit-obra-previsao-inicial-medicao');
        previsaoInicialMedicaoInput.value = obra.previsaoInicialMedicao || '';
        previsaoInicialMedicaoInput.disabled = !!obra.previsaoInicialMedicao;
        document.getElementById('edit-obra-nova-previsao-medicao').value = obra.novaPrevisaoMedicao || '';
        document.getElementById('edit-obra-medicao-efetuada').value = obra.medicaoEfetuada || '';
        const previsaoInicialEntregaInput = document.getElementById('edit-obra-previsao-inicial-entrega');
        previsaoInicialEntregaInput.value = obra.previsaoInicialEntrega || '';
        previsaoInicialEntregaInput.disabled = !!obra.previsaoInicialEntrega;
        document.getElementById('edit-obra-nova-previsao-entrega').value = obra.novaPrevisaoEntrega || '';
        document.getElementById('edit-obra-entrega-realizada').value = obra.entregaRealizada || '';
        document.getElementById('edit-obra-obs-medicao').value = obra.obsMedicao || '';
        document.getElementById('edit-obra-obs-entrega').value = obra.obsEntrega || '';
        editObraModal.classList.remove('hidden');
        setTimeout(() => { editObraModal.classList.remove('opacity-0'); }, 10);
    };

    const fecharModalAlterarObra = () => { editObraModal.classList.add('opacity-0'); setTimeout(() => editObraModal.classList.add('hidden'), 200); };

    const salvarAlteracaoObra = async () => {
        const { obraId } = edicaoObraAtual;
        const nome = document.getElementById('edit-obra-nome').value.trim();
        const cliente = document.getElementById('edit-obra-cliente').value.trim();
        if (nome && cliente) {
            const obraDocRef = doc(db, 'obras', obraId);
            const dadosAtualizados = {
                nome: nome,
                cliente: cliente,
                endereco: document.getElementById('edit-obra-endereco').value.trim(),
                novaPrevisaoMedicao: document.getElementById('edit-obra-nova-previsao-medicao').value,
                medicaoEfetuada: document.getElementById('edit-obra-medicao-efetuada').value,
                novaPrevisaoEntrega: document.getElementById('edit-obra-nova-previsao-entrega').value,
                entregaRealizada: document.getElementById('edit-obra-entrega-realizada').value,
                obsMedicao: document.getElementById('edit-obra-obs-medicao').value,
                obsEntrega: document.getElementById('edit-obra-obs-entrega').value,
            };
            if (!document.getElementById('edit-obra-previsao-inicial-medicao').disabled) dadosAtualizados.previsaoInicialMedicao = document.getElementById('edit-obra-previsao-inicial-medicao').value;
            if (!document.getElementById('edit-obra-previsao-inicial-entrega').disabled) dadosAtualizados.previsaoInicialEntrega = document.getElementById('edit-obra-previsao-inicial-entrega').value;
            await updateDoc(obraDocRef, dadosAtualizados);
            fecharModalAlterarObra();
        } else { alert('Nome da Obra e do Cliente não podem estar vazios.'); }
    };

    const renderizarFormulario = () => {
        if (isFormularioNovaObraVisivel) {
            formNovaObraContainer.classList.remove('hidden');
            btnToggleFormObra.textContent = 'FECHAR';
            btnToggleFormObra.classList.replace('bg-blue-600', 'bg-gray-500');
            btnToggleFormObra.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
        } else {
            formNovaObraContainer.classList.add('hidden');
            btnToggleFormObra.textContent = 'NOVA OBRA';
            btnToggleFormObra.classList.replace('bg-gray-500', 'bg-blue-600');
            btnToggleFormObra.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
        }
    };

    async function handleButtonClick(e) {
        const button = e.target.closest('button'); if (!button) return;
        const { obraId, itemId, materialId } = button.dataset;
        if (button.classList.contains('btn-toggle-dados')) { uiState[obraId] = { ...uiState[obraId], dadosExpanded: !uiState[obraId]?.dadosExpanded }; aplicarFiltrosERenderizar(); }
        else if (button.classList.contains('btn-toggle-itens')) { const newState = !uiState[obraId]?.isExpanded; Object.keys(uiState).forEach(id => uiState[id] = {...uiState[id], isExpanded: false }); uiState[obraId] = { ...uiState[obraId], isExpanded: newState }; aplicarFiltrosERenderizar(); }
        else if (button.classList.contains('btn-excluir-obra')) {
            const obra = obras.find(o => o.id === obraId);
            const senha = prompt('Para excluir a obra, digite a senha de confirmação:');
            if (senha === '5866') {
                if (confirm(`Tem certeza que deseja EXCLUIR a obra "${obra.nome}" e todos os seus itens permanentemente? Esta ação não pode ser desfeita.`)) {
                    await deleteDoc(doc(db, 'obras', obraId));
                }
            } else if (senha !== null) {
                alert('Senha incorreta.');
            }
        }
        else if (button.classList.contains('btn-alterar-obra')) { abrirModalAlterarObra(obraId); }
        else if (button.id === 'btnAdicionarObra') {
            const nome = document.getElementById('inputNomeObra').value.trim(); const cliente = document.getElementById('inputClienteObra').value.trim();
            if (nome && cliente) {
                const novaObra = { nome, cliente, endereco: document.getElementById('inputEnderecoObra').value.trim(), previsaoInicialMedicao: document.getElementById('inputPrevisaoInicialMedicao').value, novaPrevisaoMedicao: document.getElementById('inputNovaPrevisaoMedicao').value, medicaoEfetuada: document.getElementById('inputMedicaoEfetuada').value, previsaoInicialEntrega: document.getElementById('inputPrevisaoInicialEntrega').value, novaPrevisaoEntrega: document.getElementById('inputNovaPrevisaoEntrega').value, entregaRealizada: document.getElementById('inputEntregaRealizada').value, obsMedicao: document.getElementById('inputObsMedicao').value.trim(), obsEntrega: document.getElementById('inputObsEntrega').value.trim(), itens: [] };
                await addDoc(obrasCollection, novaObra);
                ['inputNomeObra', 'inputClienteObra', 'inputEnderecoObra', 'inputPrevisaoInicialMedicao', 'inputNovaPrevisaoMedicao', 'inputMedicaoEfetuada', 'inputPrevisaoInicialEntrega', 'inputNovaPrevisaoEntrega', 'inputEntregaRealizada', 'inputObsMedicao', 'inputObsEntrega'].forEach(id => document.getElementById(id).value = '');
                isFormularioNovaObraVisivel = false; renderizarFormulario();
            } else { alert('Preencha pelo menos o Nome da Obra e do Cliente.'); }
        } else if (button.classList.contains('btn-add-item')) {
            const obra = obras.find(o => o.id === obraId);
            const tipo = document.querySelector(`.input-add-item-tipo[data-obra-id="${obraId}"]`).value;
            const codigo = document.querySelector(`.input-add-item-codigo[data-obra-id="${obraId}"]`).value.trim();
            const descricao = document.querySelector(`.input-add-item-descricao[data-obra-id="${obraId}"]`).value.trim();
            if (codigo && descricao) {
                const novoItem = { id: Date.now().toString(), tipo, codigo, descricao, etapas: {}, materiais: [] };
                
                const dataAtual = new Date().toISOString().split('T')[0];
                const statusInicial = { status: 'nao-iniciado', data: dataAtual, statusDates: { 'nao-iniciado': dataAtual } };
                if (tipo === 'Orçamento' || tipo === 'Revisão') {
                    novoItem.etapas.alteracaoProjeto = statusInicial;
                } else if (tipo === 'Projeto' || tipo === 'Terceiros') {
                    novoItem.etapas.projetoFinal = statusInicial;
                }

                if (tipo === 'Projeto') { novoItem.largura = document.querySelector(`.input-add-item-largura[data-obra-id="${obraId}"]`).value.trim(); novoItem.altura = document.querySelector(`.input-add-item-altura[data-obra-id="${obraId}"]`).value.trim(); novoItem.m2Total = document.querySelector(`.input-add-item-m2-total[data-obra-id="${obraId}"]`).value.trim(); novoItem.cor = document.querySelector(`.input-add-item-cor[data-obra-id="${obraId}"]`).value.trim(); novoItem.vidro = document.querySelector(`.input-add-item-vidro[data-obra-id="${obraId}"]`).value.trim(); novoItem.m2Vidro = document.querySelector(`.input-add-item-m2-vidro[data-obra-id="${obraId}"]`).value.trim(); }
                else if (tipo === 'Orçamento') { novoItem.qtdPecas = document.querySelector(`.input-add-item-qtd-pecas[data-obra-id="${obraId}"]`).value.trim(); }
                else if (tipo === 'Revisão') { novoItem.versao = document.querySelector(`.input-add-item-versao[data-obra-id="${obraId}"]`).value.trim(); novoItem.revisaoAprovada = document.querySelector(`.input-add-item-revisao-check[data-obra-id="${obraId}"]`).checked; }
                const itensAtualizados = [...(obra.itens || []), novoItem];
                await updateDoc(doc(db, 'obras', obraId), { itens: itensAtualizados });
                document.querySelector(`.input-add-item-codigo[data-obra-id="${obraId}"]`).value = ''; document.querySelector(`.input-add-item-descricao[data-obra-id="${obraId}"]`).value = '';
            } else { alert('Preencha o Código e a Descrição do item.'); }
        } else if (button.classList.contains('btn-add-material')) {
            const tipoInput = document.querySelector(`.input-material-tipo[data-item-id="${itemId}"]`); 
            const descInput = document.querySelector(`.input-material-desc[data-item-id="${itemId}"]`);
            if (tipoInput.value.trim() && descInput.value.trim()) {
                const obra = obras.find(o => o.id === obraId); 
                const item = obra.itens.find(p => p.id === itemId);
                const dataAtual = new Date().toISOString().split('T')[0];
                const statusInicial = { status: 'naoIniciado', data: dataAtual, statusDates: { 'naoIniciado': dataAtual } };
                const novoMaterial = { id: Date.now().toString(), tipo: tipoInput.value.trim(), descricao: descInput.value.trim(), statusInfo: statusInicial};

                if (item.tipo === 'Compra Inicial' || item.tipo === 'Projeto') { 
                    novoMaterial.qtdeOrcada = document.querySelector(`.input-material-qtde-orcada[data-item-id="${itemId}"]`).value.trim(); 
                    novoMaterial.qtdeDisponivel = document.querySelector(`.input-material-qtde-disponivel[data-item-id="${itemId}"]`).value.trim(); 
                }
                item.materiais = [...(item.materiais || []), novoMaterial];
                await updateDoc(doc(db, 'obras', obraId), { itens: obra.itens });
                tipoInput.value = ''; 
                descInput.value = '';
                const qtdeOrcadaInput = document.querySelector(`.input-material-qtde-orcada[data-item-id="${itemId}"]`);
                const qtdeDisponivelInput = document.querySelector(`.input-material-qtde-disponivel[data-item-id="${itemId}"]`);
                if (qtdeOrcadaInput) qtdeOrcadaInput.value = '';
                if (qtdeDisponivelInput) qtdeDisponivelInput.value = '';
            }
        } else if (button.classList.contains('btn-excluir-item')) {
            const obra = obras.find(o => o.id === obraId);
            const item = obra.itens.find(i => i.id === itemId);
            if (confirm(`Tem certeza que deseja excluir o item "${item.codigo} - ${item.descricao}"?`)) {
                const itensAtualizados = obra.itens.filter(p => p.id !== itemId);
                await updateDoc(doc(db, 'obras', obraId), { itens: itensAtualizados });
            }
        }
        else if (button.classList.contains('btn-alterar-item')) { abrirModalAlterarItem(obraId, itemId); }
        else if (button.classList.contains('btn-toggle-materiais')) { const currentExpanded = uiState[obraId]?.itemExpandidoId; uiState[obraId] = { ...uiState[obraId], itemExpandidoId: currentExpanded === itemId ? null : itemId }; aplicarFiltrosERenderizar(); }
        else if (button.classList.contains('btn-excluir-material')) { 
            const obra = obras.find(o => o.id === obraId);
            const item = obra.itens.find(i => i.id === itemId);
            const material = item.materiais.find(m => m.id === materialId);
            if(confirm(`Deseja EXCLUIR o material "${material.tipo} - ${material.descricao}"?`)) { 
                item.materiais = (item.materiais || []).filter(m => m.id !== materialId); 
                await updateDoc(doc(db, 'obras', obraId), { itens: obra.itens }); 
            } 
        }
        else if (button.classList.contains('btn-alterar-material')) { abrirModalAlterarMaterial(obraId, itemId, materialId); }
    }

    const handleItemFileUpload = (e) => {
        const file = e.target.files[0]; if (!file) return; 
        const { obraId } = e.target.dataset;
        const tipoSelecionado = document.querySelector(`.input-add-item-tipo[data-obra-id="${obraId}"]`).value;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                parseSheetDataAndAddItems(jsonData, obraId, tipoSelecionado);
            } catch (error) { console.error("Erro ao processar o arquivo:", error); alert("Erro ao ler o arquivo."); }
        };
        reader.readAsArrayBuffer(file); e.target.value = '';
    };

    const parseSheetDataAndAddItems = async (sheetData, obraId, tipoItem) => {
        const obra = obras.find(o => o.id === obraId); if (!obra) return;
        const requiredHeaders = ['Tipo', 'Código', 'Descrição', 'L', 'H', 'M2 Total', 'Tratamento/Cor', 'Vidro', 'M2 Vidro Tot.', 'Qtde'];
        let headerRowIndex = -1, headers = [];
        for (let i = 0; i < sheetData.length; i++) {
            const row = sheetData[i]; if (!Array.isArray(row)) continue;
            const foundHeaders = requiredHeaders.filter(h => row.includes(h));
            if (foundHeaders.length > 5) { headerRowIndex = i; headers = row; break; }
        }
        if (headerRowIndex === -1) { alert("Cabeçalho não encontrado na planilha."); return; }
        const headerMap = {};
        try {
            requiredHeaders.forEach(h => {
                const index = headers.findIndex(header => String(header).trim() === h);
                if (index === -1) throw new Error(`Cabeçalho obrigatório não encontrado: "${h}"`);
                headerMap[h] = index;
            });
        } catch (e) { alert(e.message); return; }
        const newItems = [];
        for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
            const row = sheetData[i]; if (!row || row.length === 0 || row.every(cell => cell === null || cell === '')) continue;
            const qtde = parseFloat(String(row[headerMap['Qtde']] || 1).trim()); if (isNaN(qtde) || qtde < 1) continue;
            for (let j = 0; j < qtde; j++) {
                const dataAtual = new Date().toISOString().split('T')[0];
                const statusInicial = { status: 'nao-iniciado', data: dataAtual, statusDates: { 'nao-iniciado': dataAtual } };
                let etapasIniciais = {};
                if (tipoItem === 'Orçamento' || tipoItem === 'Revisão') {
                    etapasIniciais.alteracaoProjeto = statusInicial;
                } else if (tipoItem === 'Projeto' || tipoItem === 'Terceiros') {
                    etapasIniciais.projetoFinal = statusInicial;
                }

                const newItem = { 
                    id: `${Date.now()}-${i}-${j}`, 
                    tipo: tipoItem, 
                    etapas: etapasIniciais, 
                    materiais: [], 
                    codigo: row[headerMap['Tipo']] || '', 
                    descricao: `${row[headerMap['Código']] || ''} - ${row[headerMap['Descrição']] || ''}`
                };
                if (tipoItem === 'Projeto') {
                    newItem.altura = row[headerMap['L']] || '';
                    newItem.largura = row[headerMap['H']] || '';
                    newItem.m2Total = row[headerMap['M2 Total']] || '';
                    newItem.cor = row[headerMap['Tratamento/Cor']] || '';
                    newItem.vidro = row[headerMap['Vidro']] || '';
                    newItem.m2Vidro = row[headerMap['M2 Vidro Tot.']] || '';
                }
                newItems.push(newItem);
            }
        }
        if (newItems.length > 0) {
            const itensAtualizados = [...(obra.itens || []), ...newItems];
            await updateDoc(doc(db, 'obras', obraId), { itens: itensAtualizados });
            alert(`${newItems.length} itens foram adicionados com sucesso!`);
        } else { alert("Nenhum item válido encontrado na planilha."); }
    };

    const handleMaterialFileUpload = (e) => {
        const file = e.target.files[0]; if (!file) return; const { obraId, itemId } = e.target.dataset;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                 const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                parseXlsxAndAddMaterials(jsonData, obraId, itemId);
            } catch (error) { console.error("Erro ao processar o arquivo XLSX:", error); alert("Erro ao ler o arquivo XLSX."); }
        };
        reader.readAsArrayBuffer(file); e.target.value = '';
    };

    const parseXlsxAndAddMaterials = async (sheetData, obraId, itemId) => {
        const obra = obras.find(o => o.id === obraId); const item = obra?.itens.find(i => i.id === itemId); if (!obra || !item) { alert("Erro: Obra ou item não encontrado."); return; }
        const novosMateriais = []; let headerFound = false;
        for (const linha of sheetData) {
            if (!linha || linha.length < 4) continue;
            const colA = linha[0] ? String(linha[0]).trim() : ''; const colB = linha[1] ? String(linha[1]).trim() : '';
            if (colA.toUpperCase().startsWith('DOC') && colB.toUpperCase() === 'DESCRIÇÃO') { headerFound = true; continue; }
            if (headerFound) {
                 const qtdeOrcada = linha[3] ? String(linha[3]).trim() : '';
                if (colA && colB && qtdeOrcada) {
                    const dataAtual = new Date().toISOString().split('T')[0];
                    const statusInicial = { status: 'naoIniciado', data: dataAtual, statusDates: { 'naoIniciado': dataAtual } };
                    novosMateriais.push({ id: `${Date.now()}-${Math.random()}`, tipo: colA, descricao: colB, statusInfo: statusInicial, qtdeOrcada: qtdeOrcada, qtdeDisponivel: '' });
                }
            }
        }
        if (novosMateriais.length > 0) {
            item.materiais = [...(item.materiais || []), ...novosMateriais];
            await updateDoc(doc(db, 'obras', obraId), { itens: obra.itens });
            alert(`${novosMateriais.length} materiais foram importados com sucesso!`);
        } else { alert("Nenhum material válido foi encontrado na planilha. Verifique o cabeçalho ('DOC', 'DESCRIÇÃO')."); }
    };

    document.addEventListener('click', (e) => {
        handleButtonClick(e);
        const badge = e.target.closest('.status-badge');
        if (badge) {
            const { obraId, itemId, etapaId, materialId } = badge.dataset;
            abrirModal(obraId, itemId, etapaId, materialId);
        }
    });
    
    const toggleProjetoFieldsModal = (tipo) => {
        const fieldsContainer = document.getElementById('edit-item-projeto-fields');
        if (fieldsContainer) {
            fieldsContainer.classList.toggle('hidden', tipo !== 'Projeto');
            fieldsContainer.classList.toggle('space-y-4', tipo === 'Projeto');
        }
    };

    const toggleOrcamentoRevisaoFieldsModal = (tipo) => {
        const container = document.getElementById('edit-item-orcamento-revisao-fields');
        const orcamentoFields = document.getElementById('edit-orcamento-fields-container');
        const revisaoFields = document.getElementById('edit-revisao-fields-container');
        
        const show = tipo === 'Orçamento' || tipo === 'Revisão';
        container.classList.toggle('hidden', !show);
        container.classList.toggle('space-y-4', show);

        orcamentoFields.classList.toggle('hidden', tipo !== 'Orçamento');
        revisaoFields.classList.toggle('hidden', tipo !== 'Revisão');
    };

    const toggleProjetoFields = (tipo, obraId) => {
        const fieldsContainer = document.getElementById(`add-item-projeto-fields-${obraId}`);
        const uploadContainer = document.getElementById(`upload-itens-container-${obraId}`);
        if (fieldsContainer && uploadContainer) {
            fieldsContainer.classList.toggle('hidden', tipo !== 'Projeto');
            fieldsContainer.classList.toggle('grid', tipo === 'Projeto');
            uploadContainer.classList.toggle('hidden', tipo !== 'Projeto' && tipo !== 'Revisão');
        }
    };
    
    const toggleOrcamentoRevisaoFields = (tipo, obraId) => {
        const container = document.getElementById(`add-item-orcamento-revisao-fields-${obraId}`);
        const orcamentoFields = document.getElementById(`add-orcamento-fields-container-${obraId}`);
        const revisaoFields = document.getElementById(`add-revisao-fields-container-${obraId}`);
        
        const show = tipo === 'Orçamento' || tipo === 'Revisão';
        container.classList.toggle('hidden', !show);
        container.classList.toggle('flex', show);
        
        if (orcamentoFields) orcamentoFields.classList.toggle('hidden', tipo !== 'Orçamento');
        if (revisaoFields) revisaoFields.classList.toggle('hidden', tipo !== 'Revisão');
    };


    document.addEventListener('change', (e) => {
        if (e.target.matches('input[id^="upload-itens-"]')) handleItemFileUpload(e);
        if (e.target.matches('input[id^="upload-materiais-"]')) handleMaterialFileUpload(e);
        if (e.target.matches('.input-add-item-tipo')) {
            const obraId = e.target.dataset.obraId;
            const tipo = e.target.value;
            toggleProjetoFields(tipo, obraId);
            toggleOrcamentoRevisaoFields(tipo, obraId);
        }
        if (e.target.matches('#edit-item-tipo')) {
            toggleProjetoFieldsModal(e.target.value);
            toggleOrcamentoRevisaoFieldsModal(e.target.value);
        }
    });

    const popularFiltros = () => {
        const tipoItemContainer = document.getElementById('filtro-tipo-item-container');
        const tipos = Object.keys(TIPO_ITEM_STYLE_MAP);
        let tipoCheckboxesHtml = `<div class="flex items-center"><input type="checkbox" id="filtro-tipo-todos" class="filtro-tipo-checkbox-todos h-4 w-4 rounded"><label for="filtro-tipo-todos" class="ml-2 text-sm font-semibold">Todos</label></div>`;
        tipos.forEach(tipo => { tipoCheckboxesHtml += `<div class="flex items-center"><input type="checkbox" id="filtro-tipo-${tipo}" value="${tipo}" class="filtro-tipo-checkbox h-4 w-4 rounded"><label for="filtro-tipo-${tipo}" class="ml-2 text-sm">${tipo}</label></div>`; });
        tipoItemContainer.innerHTML = tipoCheckboxesHtml;
        
        const statusMaterialContainer = document.getElementById('filtro-status-material-container');
        const statusMateriais = Object.entries(STATUS_MATERIAL_MAP).filter(([key]) => key !== 'default');
        let matCheckboxesHtml = `<div class="flex items-center col-span-2"><input type="checkbox" id="filtro-mat-todos" class="filtro-mat-checkbox-todos h-4 w-4 rounded"><label for="filtro-mat-todos" class="ml-2 text-sm font-semibold">Todos os Status</label></div>`;
        matCheckboxesHtml += `<div class="flex items-center gap-x-2 col-span-4"><label class="text-sm font-bold text-green-700 uppercase">Conferido Estoque:</label><input type="checkbox" id="filtro-mat-estoque-s" data-estoque-filter="S" class="filtro-mat-estoque-option h-4 w-4 rounded"><label for="filtro-mat-estoque-s" class="text-sm">S</label><input type="checkbox" id="filtro-mat-estoque-n" data-estoque-filter="N" class="filtro-mat-estoque-option h-4 w-4 rounded"><label for="filtro-mat-estoque-n" class="text-sm">N</label></div>`;
        statusMateriais.forEach(([key, value]) => { matCheckboxesHtml += `<div class="flex items-center"><input type="checkbox" id="filtro-mat-${key}" value="${key}" class="filtro-mat-status-checkbox h-4 w-4 rounded"><label for="filtro-mat-${key}" class="ml-2 text-sm">${value.texto}</label></div>`; });
        statusMaterialContainer.innerHTML = matCheckboxesHtml;
        
        const filtrosStatusContainer = document.getElementById('filtros-status-item-container');
        filtrosStatusContainer.innerHTML = ETAPAS_ITEM.map(etapa => `<div><label for="filtro-status-${etapa.id}" class="text-sm font-medium text-gray-600">${etapa.nome}</label><select id="filtro-status-${etapa.id}" data-etapa-id="${etapa.id}" class="filtro-status-item w-full p-2 border rounded-lg mt-1"><option value="todos">Todos</option>${Object.entries(STATUS_ITEM_MAP).filter(([key]) => key !== 'default').map(([key, value]) => `<option value="${key}">${value.texto}</option>`).join('')}</select></div>`).join('');
        
        filtros = { nomeObra: '', tipoItem: [], statusMaterial: [], estoque: null, statusItem: ETAPAS_ITEM.reduce((acc, etapa) => ({...acc, [etapa.id]: 'todos'}), {}) };
    };

    const adicionarListenersFiltros = () => {
        document.getElementById('filtro-nome-obra').addEventListener('input', (e) => { filtros.nomeObra = e.target.value; aplicarFiltrosERenderizar(); });
        document.getElementById('filtro-tipo-item-container').addEventListener('change', (e) => {
            const target = e.target; if (target.type !== 'checkbox') return;
            const todosCheckbox = document.getElementById('filtro-tipo-todos'); const tipoCheckboxes = document.querySelectorAll('.filtro-tipo-checkbox');
            if (target.id === 'filtro-tipo-todos') tipoCheckboxes.forEach(cb => cb.checked = target.checked); else todosCheckbox.checked = [...tipoCheckboxes].every(cb => cb.checked);
            filtros.tipoItem = [...document.querySelectorAll('.filtro-tipo-checkbox:checked')].map(cb => cb.value);
            if (todosCheckbox.checked) filtros.tipoItem = [];
            aplicarFiltrosERenderizar();
        });
        document.getElementById('filtro-status-material-container').addEventListener('change', (e) => {
            const target = e.target; if (target.type !== 'checkbox') return;
            
            const todosCheckbox = document.getElementById('filtro-mat-todos');
            const statusCheckboxes = document.querySelectorAll('.filtro-mat-status-checkbox');
            const estoqueCheckboxes = document.querySelectorAll('.filtro-mat-estoque-option');

            if (target.id === 'filtro-mat-todos') {
                statusCheckboxes.forEach(cb => cb.checked = target.checked);
            } else if (target.classList.contains('filtro-mat-status-checkbox')) {
                todosCheckbox.checked = [...statusCheckboxes].every(cb => cb.checked);
            } else if (target.classList.contains('filtro-mat-estoque-option')) {
                if (target.checked) {
                    estoqueCheckboxes.forEach(cb => { if (cb !== target) { cb.checked = false; }});
                }
            }

            filtros.statusMaterial = [...document.querySelectorAll('.filtro-mat-status-checkbox:checked')].map(cb => cb.value);
            if (todosCheckbox.checked) filtros.statusMaterial = [];

            const checkedEstoqueBox = document.querySelector('.filtro-mat-estoque-option:checked');
            filtros.estoque = checkedEstoqueBox ? checkedEstoqueBox.dataset.estoqueFilter : null;

            aplicarFiltrosERenderizar();
        });
        document.querySelectorAll('.filtro-status-item').forEach(select => { select.addEventListener('change', (e) => { filtros.statusItem[e.target.dataset.etapaId] = e.target.value; aplicarFiltrosERenderizar(); }); });
    };

    btnToggleFormObra.addEventListener('click', () => { isFormularioNovaObraVisivel = !isFormularioNovaObraVisivel; renderizarFormulario(); });
    document.getElementById('modal-btn-salvar').addEventListener('click', salvarStatus);
    document.getElementById('modal-btn-cancelar').addEventListener('click', fecharModal);
    document.getElementById('edit-item-btn-salvar').addEventListener('click', salvarAlteracaoItem);
    document.getElementById('edit-item-btn-cancelar').addEventListener('click', fecharModalAlterarItem);
    document.getElementById('edit-material-btn-salvar').addEventListener('click', salvarAlteracaoMaterial);
    document.getElementById('edit-material-btn-cancelar').addEventListener('click', fecharModalAlterarMaterial);
    document.getElementById('edit-obra-btn-salvar').addEventListener('click', salvarAlteracaoObra);
    document.getElementById('edit-obra-btn-cancelar').addEventListener('click', fecharModalAlterarObra);

    popularFiltros();
    adicionarListenersFiltros();
});
</script>

</body>
</html>